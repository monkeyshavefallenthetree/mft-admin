<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Monkeys Have Fallen The Tree</title>
    
    <!-- Firebase v9 SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc, where, addDoc, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAszc76bGqYvAOSqZ5ZuxWDQNqdw8We2uc",
  authDomain: "monkeys-have-fallen-tree.firebaseapp.com",
  projectId: "monkeys-have-fallen-tree",
  storageBucket: "monkeys-have-fallen-tree.firebasestorage.app",
  messagingSenderId: "585775814693",
  appId: "1:585775814693:web:fdab2f5af6a0a1e39687cc",
  measurementId: "G-YTQ38QQFEL"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase functions available globally
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.where = where;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
        window.analytics = analytics;
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Header */
        .dashboard-header {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(239, 65, 75, 0.3);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ef414b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-title::before {
            content: 'üî•';
            font-size: 1.2rem;
        }

        .dashboard-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ef414b;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .firebase-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #28a745;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: livePulse 2s infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .refresh-btn {
            background: #ef414b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #d63641;
            transform: translateY(-1px);
        }

        /* Main content */
        .dashboard-main {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .filters-section {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(239, 65, 75, 0.2);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.8rem;
            color: #cccccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .filter-select,
        .filter-input {
            padding: 8px 12px;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid rgba(239, 65, 75, 0.3);
            border-radius: 6px;
            color: #ffffff;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #ef414b;
        }

        .filter-select option {
            background: #2a2a2a;
            color: #ffffff;
        }

        /* Submissions grid */
        .submissions-container {
            display: grid;
            gap: 25px;
        }

        .submission-card {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(239, 65, 75, 0.2);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
            animation: cardFadeIn 0.5s ease-out;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .submission-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(239, 65, 75, 0.05), transparent);
            transition: left 0.8s ease;
        }

        .submission-card:hover::before {
            left: 100%;
        }

        .submission-card:hover {
            border-color: rgba(239, 65, 75, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(239, 65, 75, 0.1);
        }

        .submission-card.new {
            border-color: #28a745;
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.2);
        }

        .submission-card.new::after {
            content: 'NEW';
            position: absolute;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ef414b;
            margin-bottom: 5px;
        }

        .client-email {
            color: #cccccc;
            font-size: 0.95rem;
            margin-bottom: 3px;
        }

        .client-company {
            color: #aaaaaa;
            font-size: 0.9rem;
        }

        .submission-meta {
            text-align: right;
            min-width: 150px;
        }

        .submission-date {
            color: #cccccc;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .submission-id {
            color: #888888;
            font-size: 0.75rem;
            font-family: monospace;
        }

        .project-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .detail-group {
            background: rgba(30, 30, 30, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(239, 65, 75, 0.1);
        }

        .detail-label {
            font-size: 0.8rem;
            color: #ef414b;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #ffffff;
            font-size: 0.95rem;
        }

        .budget-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ef414b, #ff6b75);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .timeline-badge {
            display: inline-block;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid;
        }

        .status-new {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border-color: #28a745;
        }

        .status-contacted {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
            border-color: #007bff;
        }

        .status-in-progress {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-color: #ffc107;
        }

        .status-completed {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
            border-color: #6c757d;
        }

        .status-badge.online {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border-color: #28a745;
        }

        .status-badge.offline {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border-color: #dc3545;
        }

        .status-badge.status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-color: #ffc107;
        }

        .status-badge.status-approved {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border-color: #28a745;
        }

        .status-badge.status-rejected {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border-color: #dc3545;
        }

        .worker-info-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .worker-info-section h4 {
            border-bottom: 1px solid rgba(239, 65, 75, 0.3);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        /* Responsive styles for worker info sections */
        @media (max-width: 768px) {
            .worker-info-section {
                padding: 12px;
            }
            
            .worker-details .worker-info-section {
                grid-template-columns: 1fr;
            }
        }

        /* Worker Dashboard Modal Styles */
        .worker-dashboard-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .worker-dashboard-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            margin: 2% auto;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            border-radius: 20px;
            border: 1px solid rgba(239, 65, 75, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .worker-dashboard-header {
            background: linear-gradient(135deg, #ef414b 0%, #d63641 100%);
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .worker-profile-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .worker-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .worker-profile-info h2 {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0 0 5px 0;
        }

        .worker-profile-info p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0 0 10px 0;
        }

        .worker-status-indicators {
            display: flex;
            gap: 10px;
        }

        .close-worker-dashboard {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-worker-dashboard:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .worker-dashboard-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* Stats Row */
        .worker-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card-modern {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .stat-card-modern:hover {
            transform: translateY(-5px);
            border-color: rgba(239, 65, 75, 0.3);
            box-shadow: 0 10px 30px rgba(239, 65, 75, 0.1);
        }

        .stat-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            background: rgba(239, 65, 75, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ef414b;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #cccccc;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Dashboard Tabs */
        .worker-dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
        }

        .dashboard-tab {
            background: transparent;
            border: none;
            color: #cccccc;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .dashboard-tab:hover {
            background: rgba(239, 65, 75, 0.1);
            color: #ef414b;
        }

        .dashboard-tab.active {
            background: rgba(239, 65, 75, 0.2);
            color: #ef414b;
            border-color: rgba(239, 65, 75, 0.3);
        }

        /* Tab Panels */
        .dashboard-tab-panel {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .dashboard-tab-panel.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Overview Tab */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .overview-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .overview-section h3 {
            color: #ef414b;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(239, 65, 75, 0.3);
            padding-bottom: 10px;
        }

        .info-grid {
            display: grid;
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #cccccc;
            font-weight: 500;
        }

        .info-value {
            color: #ffffff;
            font-weight: 600;
        }

        /* Activity Timeline */
        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border-left: 3px solid #ef414b;
        }

        .timeline-icon {
            width: 40px;
            height: 40px;
            background: rgba(239, 65, 75, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .timeline-time {
            color: #888888;
            font-size: 0.9rem;
        }

        /* Attendance Tab */
        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .attendance-stat {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .attendance-stat .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: #ef414b;
            margin-bottom: 5px;
        }

        .attendance-stat .stat-label {
            color: #cccccc;
            font-size: 0.9rem;
        }

        /* Tasks Tab */
        .task-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-stat {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-stat .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: #ef414b;
            margin-bottom: 5px;
        }

        .task-stat .stat-label {
            color: #cccccc;
            font-size: 0.9rem;
        }

        /* Performance Tab */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .metric-icon {
            font-size: 1.5rem;
        }

        .metric-title {
            color: #ffffff;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ef414b;
            margin-bottom: 15px;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .metric-progress {
            height: 100%;
            background: linear-gradient(90deg, #ef414b 0%, #d63641 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Payroll Tab */
        .payroll-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }

        .payroll-card h4 {
            color: #ef414b;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .payroll-details {
            display: grid;
            gap: 15px;
        }

        .payroll-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .payroll-item:last-child {
            border-bottom: none;
        }

        .payroll-item.total {
            font-weight: 700;
            color: #ef414b;
            font-size: 1.1rem;
            border-top: 2px solid rgba(239, 65, 75, 0.3);
            padding-top: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .worker-dashboard-content {
                width: 98%;
                height: 95vh;
                margin: 1% auto;
            }

            .worker-dashboard-header {
                padding: 20px;
                flex-direction: column;
                gap: 20px;
            }

            .worker-profile-section {
                flex-direction: column;
                text-align: center;
            }

            .worker-dashboard-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }

            .dashboard-tab {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .worker-stats-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .overview-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .performance-metrics {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .services-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .service-tag {
            background: rgba(239, 65, 75, 0.2);
            color: #ef414b;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .project-description {
            background: rgba(30, 30, 30, 0.6);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #ef414b;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .description-label {
            font-size: 0.9rem;
            color: #ef414b;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .description-text {
            color: #e0e0e0;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .submission-actions {
            display: flex;
            gap: 15px;
            position: relative;
            z-index: 2;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-contact {
            background: #ef414b;
            color: white;
        }

        .btn-contact:hover {
            background: #d63641;
            transform: translateY(-1px);
        }

        .btn-status {
            background: transparent;
            color: #007bff;
            border: 1px solid #007bff;
        }

        .btn-status:hover {
            background: #007bff;
            color: white;
        }

        .btn-delete {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .btn-delete:hover {
            background: #dc3545;
            color: white;
        }

        /* Phase Management */
        .phase-management {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .phase-header h4 {
            color: #ef414b;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .phase-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .phase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .phase-item.pending {
            border-color: rgba(255, 193, 7, 0.3);
            background: rgba(255, 193, 7, 0.05);
        }

        .phase-item.in-progress {
            border-color: rgba(0, 123, 255, 0.3);
            background: rgba(0, 123, 255, 0.05);
        }

        .phase-item.completed {
            border-color: rgba(40, 167, 69, 0.3);
            background: rgba(40, 167, 69, 0.05);
        }

        .phase-label {
            font-weight: 600;
            color: #ffffff;
        }

        .phase-buttons {
            display: flex;
            gap: 8px;
        }

        .phase-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .phase-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: #007bff;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-complete {
            background: #28a745;
            color: white;
        }

        .btn-complete:hover:not(:disabled) {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        /* No submissions state */
        .no-submissions {
            text-align: center;
            padding: 60px 20px;
            color: #666666;
        }

        .no-submissions-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-submissions-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .no-submissions-subtitle {
            font-size: 0.95rem;
            opacity: 0.7;
        }

        /* Loading state */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            color: #ef414b;
            font-size: 1.1rem;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid #ef414b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .dashboard-stats {
                gap: 20px;
            }

            .dashboard-main {
                padding: 20px 15px;
            }

            .filters-section {
                padding: 20px;
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .filter-group {
                width: 100%;
            }

            .filter-select,
            .filter-input {
                width: 100%;
                min-width: auto;
            }

            .submission-header {
                flex-direction: column;
                gap: 15px;
                text-align: left;
            }

            .submission-meta {
                text-align: left;
                min-width: auto;
            }

            .project-details {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .submission-actions {
                flex-direction: column;
                gap: 10px;
            }

            .action-btn {
                width: 100%;
                text-align: center;
            }
        }



        .config-info {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            color: #007bff;
            font-size: 0.9rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(239, 65, 75, 0.3);
            padding-bottom: 10px;
        }

        .nav-tab {
            background: transparent;
            color: #cccccc;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .nav-tab:hover {
            background: rgba(239, 65, 75, 0.1);
            color: #ef414b;
        }

        .nav-tab.active {
            background: #ef414b;
            color: white;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Workers Section */
        .workers-header, .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .workers-header h2, .tasks-header h2 {
            color: #ef414b;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .workers-container, .tasks-container {
            display: grid;
            gap: 20px;
        }

        .worker-card, .task-card {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(239, 65, 75, 0.2);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .worker-card:hover, .task-card:hover {
            border-color: rgba(239, 65, 75, 0.4);
            transform: translateY(-2px);
        }

        .worker-header, .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .worker-name, .task-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ef414b;
        }

        .worker-role, .task-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .worker-role {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        .task-status.assigned {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }

        .task-status.in-progress {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .task-status.completed {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .task-status.pendingapproval {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .worker-details, .task-details {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .worker-actions, .task-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .worker-btn, .task-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #1e7e34;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .btn-assign {
            background: #007bff;
            color: white;
        }

        .btn-assign:hover {
            background: #0056b3;
        }

        .btn-view {
            background: transparent;
            color: #cccccc;
            border: 1px solid #cccccc;
        }

        .btn-view:hover {
            background: #cccccc;
            color: #000000;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: rgba(20, 20, 20, 0.95);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid rgba(239, 65, 75, 0.3);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #ef414b;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close {
            color: #cccccc;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ef414b;
        }

        .modal-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-size: 1rem;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #ef414b;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: transparent;
            color: #cccccc;
            border: 1px solid #cccccc;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel:hover {
            background: #cccccc;
            color: #000000;
        }

        .btn-submit {
            background: #ef414b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-submit:hover {
            background: #d63641;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="dashboard-title">
            Firebase Admin Dashboard
        </div>
        <div class="dashboard-stats">
            <div class="stat-item">
                <span class="stat-number" id="totalSubmissions">0</span>
                <span class="stat-label">Submissions</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalWorkers">0</span>
                <span class="stat-label">Workers</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalTasks">0</span>
                <span class="stat-label">Tasks</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="pendingApprovals">0</span>
                <span class="stat-label">Pending</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="onlineWorkers">0</span>
                <span class="stat-label">Online</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="todayWorkTime">0h</span>
                <span class="stat-label">Today's Work</span>
            </div>
        </div>
        <div class="connection-status">
            <div class="firebase-status">
                <div class="status-dot"></div>
                Real-time Connected
            </div>
            <button class="refresh-btn" onclick="manualRefresh()">
                üîÑ Refresh
            </button>
            <button class="logout-btn" onclick="logout()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                üö™ Logout
            </button>
        </div>
    </div>



    <div class="dashboard-main">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('submissions')" id="tab-submissions">
                üìù Submissions
            </button>
            <button class="nav-tab" onclick="switchTab('workers')" id="tab-workers">
                üë∑ Workers
            </button>
            <button class="nav-tab" onclick="switchTab('tasks')" id="tab-tasks">
                üìã Tasks
            </button>
            <button class="nav-tab" onclick="switchTab('worksessions')" id="tab-worksessions">
                ‚è∞ Work Sessions
            </button>
            <button class="nav-tab" onclick="switchTab('hr')" id="tab-hr">
                üè¢ HR Dashboard
            </button>
        </div>

        <!-- Submissions Tab -->
        <div id="submissions-tab" class="tab-content active">
            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Filter by Status</label>
                    <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Service</label>
                    <select class="filter-select" id="serviceFilter" onchange="applyFilters()">
                        <option value="">All Services</option>
                        <option value="branding">Branding & Identity</option>
                        <option value="media-buying">Media Buying</option>
                        <option value="digital-marketing">Digital Marketing</option>
                        <option value="media-production">Media Production</option>
                        <option value="outdoor-advertising">Outdoor Advertising</option>
                        <option value="web-development">Web & SEO Development</option>
                        <option value="printing">Printing Solutions</option>
                        <option value="event-management">Event Management</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Date</label>
                    <select class="filter-select" id="dateFilter" onchange="applyFilters()">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="tomorrow">Tomorrow</option>
                        <option value="this-week">This Week</option>
                        <option value="next-week">Next Week</option>
                        <option value="this-month">This Month</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Search</label>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Search by name, email..." oninput="applyFilters()">
                </div>
            </div>

            <div class="submissions-container" id="submissionsContainer">
                <div class="loading">üî• Connecting to Firebase...</div>
            </div>
        </div>

        <!-- Workers Tab -->
        <div id="workers-tab" class="tab-content">
            <div class="workers-header">
                <h2>Worker Management</h2>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <span class="worker-count" id="workerCount" style="background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem;">
                        Loading...
                    </span>
                    <button class="action-btn" onclick="loadWorkers()">üîÑ Refresh</button>
                </div>
            </div>

            <!-- Worker Filters -->
            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">üîç Search Workers</label>
                    <input type="text" class="filter-input" id="workerSearchFilter" placeholder="Search by name, email, role..." oninput="filterWorkers()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Status</label>
                    <select class="filter-select" id="workerStatusFilter" onchange="filterWorkers()">
                        <option value="">All Status</option>
                        <option value="approved">‚úÖ Approved</option>
                        <option value="pending">‚è≥ Pending</option>
                        <option value="rejected">‚ùå Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Role</label>
                    <select class="filter-select" id="workerRoleFilter" onchange="filterWorkers()">
                        <option value="">All Roles</option>
                        <option value="tree-cutter">ü™ì Tree Cutter</option>
                        <option value="equipment-operator">üöú Equipment Operator</option>
                        <option value="safety-supervisor">ü¶∫ Safety Supervisor</option>
                        <option value="logistics-coordinator">üì¶ Logistics Coordinator</option>
                        <option value="site-manager">üë∑ Site Manager</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="action-btn" onclick="clearWorkerFilters()" style="background: #6c757d;">Clear Filters</button>
                </div>
            </div>

            <!-- Worker Management Warning -->
            <div style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: #dc3545; margin: 0 0 10px 0;">‚ö†Ô∏è Worker Deletion Warning</h4>
                <div style="color: #fff; font-size: 0.9rem; line-height: 1.5;">
                    <strong>Deleting a worker will permanently remove:</strong><br>
                    ‚Ä¢ Worker account and profile ‚Ä¢ All work sessions and time tracking ‚Ä¢ All assigned tasks ‚Ä¢ Exception requests ‚Ä¢ Alert history<br>
                    <strong>This action cannot be undone!</strong> Use with extreme caution.
                </div>
            </div>

            <div class="workers-container" id="workersContainer">
                <div class="loading">Loading workers...</div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div id="tasks-tab" class="tab-content">
            <div class="tasks-header">
                <h2>Task Management</h2>
                <button class="action-btn" onclick="showCreateTaskModal()">‚ûï Create Task</button>
            </div>
            <div class="tasks-container" id="tasksContainer">
                <div class="loading">Loading tasks...</div>
            </div>
        </div>

        <!-- Work Sessions Tab -->
        <div id="worksessions-tab" class="tab-content">
            <div class="tasks-header">
                <h2>Work Time Reports</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" onclick="exportWorkTimeData()">üìä Export Data</button>
                    <button class="action-btn" onclick="refreshWorkSessions()">üîÑ Refresh</button>
                </div>
            </div>
            
            <!-- Work Sessions Filters -->
            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Filter by Worker</label>
                    <select class="filter-select" id="workerFilter" onchange="applyWorkSessionFilters()">
                        <option value="">All Workers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Date</label>
                    <input type="date" class="filter-input" id="dateFromFilter" onchange="applyWorkSessionFilters()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">To Date</label>
                    <input type="date" class="filter-input" id="dateToFilter" onchange="applyWorkSessionFilters()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Show</label>
                    <select class="filter-select" id="viewTypeFilter" onchange="applyWorkSessionFilters()">
                        <option value="daily">Daily Summary</option>
                        <option value="sessions">Individual Sessions</option>
                        <option value="totals">Worker Totals</option>
                    </select>
                </div>
            </div>

                         <!-- Work Sessions Summary -->
             <div class="worker-stats" style="margin-bottom: 30px;">
                 <div class="stat-card">
                     <div class="stat-number" id="totalWorkHours">-</div>
                     <div class="stat-label">Work Hours (Reg + Daily OT)</div>
                 </div>
                 <div class="stat-card">
                     <div class="stat-number" id="totalSessions">-</div>
                     <div class="stat-label">Sessions (On-time / Late)</div>
                 </div>
                 <div class="stat-card">
                     <div class="stat-number" id="activeWorkers">-</div>
                     <div class="stat-label">Workers & Attendance</div>
                 </div>
                 <div class="stat-card">
                     <div class="stat-number" id="avgSessionLength">-</div>
                     <div class="stat-label">Avg Session & Monthly OT</div>
                 </div>
             </div>

             <!-- Work Policy Info -->
             <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                 <h4 style="color: #ffc107; margin: 0 0 10px 0;">üìã Work Policy Rules</h4>
                 <div style="color: #fff; font-size: 0.9rem; line-height: 1.5;">
                     <strong>Daily Rules:</strong> Work starts 10 AM ‚Ä¢ Late 11-12 AM (-0.25 day) ‚Ä¢ Very Late 12+ PM (-0.5 day) ‚Ä¢ Daily OT >8h (x1.5 rate)<br>
                     <strong>Monthly Rules:</strong> Standard 22 working days ‚Ä¢ Monthly OT >22 days (x1.5 rate per day)
                 </div>
             </div>

            <div class="workers-container" id="workSessionsContainer">
                <div class="loading">Loading work sessions...</div>
            </div>
        </div>

        <!-- HR Dashboard Tab -->
        <div id="hr-tab" class="tab-content">
            <div class="tasks-header">
                <h2>HR Management Dashboard</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="action-btn" onclick="openSendAlertModal()">üì¢ Send Alert</button>
                    <button class="action-btn" onclick="generatePayrollReport()">üí∞ Payroll Report</button>
                    <button class="action-btn" onclick="exportAttendanceData()">üìã Export Attendance</button>
                    <button class="action-btn" onclick="refreshHRData()">üîÑ Refresh</button>
                </div>
            </div>

            <!-- Worker Dashboard Modal -->
            <div id="workerDashboardModal" class="worker-dashboard-modal">
                <div class="worker-dashboard-content">
                    <div class="worker-dashboard-header">
                        <div class="worker-profile-section">
                            <div class="worker-avatar">
                                <span id="workerAvatarInitials">JD</span>
                            </div>
                            <div class="worker-profile-info">
                                <h2 id="workerDashboardName">John Doe</h2>
                                <p id="workerDashboardRole">Web Developer</p>
                                <div class="worker-status-indicators">
                                    <span id="workerDashboardStatus" class="status-badge status-pending">PENDING</span>
                                    <span id="workerDashboardOnline" class="status-badge offline">üî¥ Offline</span>
                                </div>
                            </div>
                        </div>
                        <button class="close-worker-dashboard" onclick="closeWorkerDashboard()">√ó</button>
                    </div>

                    <div class="worker-dashboard-body">
                        <!-- Quick Stats Row -->
                        <div class="worker-stats-row">
                            <div class="stat-card-modern">
                                <div class="stat-icon">‚è∞</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="workerTotalHours">0h</div>
                                    <div class="stat-label">Total Hours</div>
                                </div>
                            </div>
                            <div class="stat-card-modern">
                                <div class="stat-icon">üìä</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="workerAttendance">0%</div>
                                    <div class="stat-label">Attendance</div>
                                </div>
                            </div>
                            <div class="stat-card-modern">
                                <div class="stat-icon">‚úÖ</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="workerTasksCompleted">0</div>
                                    <div class="stat-label">Tasks Done</div>
                                </div>
                            </div>
                            <div class="stat-card-modern">
                                <div class="stat-icon">üí∞</div>
                                <div class="stat-content">
                                    <div class="stat-number" id="workerEarnings">EGP 0</div>
                                    <div class="stat-label">Earnings</div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Tabs -->
                        <div class="worker-dashboard-tabs">
                            <button class="dashboard-tab active" onclick="switchWorkerTab('overview')" data-tab="overview">
                                üìã Overview
                            </button>
                            <button class="dashboard-tab" onclick="switchWorkerTab('attendance')" data-tab="attendance">
                                üìÖ Attendance
                            </button>
                            <button class="dashboard-tab" onclick="switchWorkerTab('tasks')" data-tab="tasks">
                                üìù Tasks
                            </button>
                            <button class="dashboard-tab" onclick="switchWorkerTab('performance')" data-tab="performance">
                                üìà Performance
                            </button>
                            <button class="dashboard-tab" onclick="switchWorkerTab('payroll')" data-tab="payroll">
                                üí∞ Payroll
                            </button>
                        </div>

                        <!-- Tab Content -->
                        <div class="worker-dashboard-tab-content">
                            <!-- Overview Tab -->
                            <div id="overview-tab" class="dashboard-tab-panel active">
                                <div class="overview-grid">
                                    <div class="overview-section">
                                        <h3>üë§ Personal Information</h3>
                                        <div class="info-grid" id="workerPersonalInfo">
                                            <!-- Personal info will be populated here -->
                                        </div>
                                    </div>
                                    <div class="overview-section">
                                        <h3>üíº Work Information</h3>
                                        <div class="info-grid" id="workerWorkInfo">
                                            <!-- Work info will be populated here -->
                                        </div>
                                    </div>
                                    <div class="overview-section">
                                        <h3>üìû Emergency Contact</h3>
                                        <div class="info-grid" id="workerEmergencyInfo">
                                            <!-- Emergency info will be populated here -->
                                        </div>
                                    </div>
                                    <div class="overview-section">
                                        <h3>üéØ Recent Activity</h3>
                                        <div class="activity-timeline" id="workerActivityTimeline">
                                            <!-- Activity timeline will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Attendance Tab -->
                            <div id="attendance-tab" class="dashboard-tab-panel">
                                <div class="attendance-chart-container">
                                    <h3>üìä Attendance Overview</h3>
                                    <div class="attendance-stats">
                                        <div class="attendance-stat">
                                            <span class="stat-value" id="attendancePresent">0</span>
                                            <span class="stat-label">Present</span>
                                        </div>
                                        <div class="attendance-stat">
                                            <span class="stat-value" id="attendanceAbsent">0</span>
                                            <span class="stat-label">Absent</span>
                                        </div>
                                        <div class="attendance-stat">
                                            <span class="stat-value" id="attendanceLate">0</span>
                                            <span class="stat-label">Late</span>
                                        </div>
                                        <div class="attendance-stat">
                                            <span class="stat-value" id="attendanceOvertime">0h</span>
                                            <span class="stat-label">Overtime</span>
                                        </div>
                                    </div>
                                    <div class="attendance-calendar" id="attendanceCalendar">
                                        <!-- Calendar will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Tasks Tab -->
                            <div id="tasks-tab" class="dashboard-tab-panel">
                                <div class="tasks-overview">
                                    <h3>üìù Task Management</h3>
                                    <div class="task-stats">
                                        <div class="task-stat">
                                            <span class="stat-value" id="taskTotal">0</span>
                                            <span class="stat-label">Total Tasks</span>
                                        </div>
                                        <div class="task-stat">
                                            <span class="stat-value" id="taskCompleted">0</span>
                                            <span class="stat-label">Completed</span>
                                        </div>
                                        <div class="task-stat">
                                            <span class="stat-value" id="taskPending">0</span>
                                            <span class="stat-label">Pending</span>
                                        </div>
                                        <div class="task-stat">
                                            <span class="stat-value" id="taskProgress">0%</span>
                                            <span class="stat-label">Progress</span>
                                        </div>
                                    </div>
                                    <div class="recent-tasks" id="recentTasksList">
                                        <!-- Recent tasks will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Tab -->
                            <div id="performance-tab" class="dashboard-tab-panel">
                                <div class="performance-overview">
                                    <h3>üìà Performance Metrics</h3>
                                    <div class="performance-metrics">
                                        <div class="metric-card">
                                            <div class="metric-header">
                                                <span class="metric-icon">‚ö°</span>
                                                <span class="metric-title">Productivity Score</span>
                                            </div>
                                            <div class="metric-value" id="productivityScore">0%</div>
                                            <div class="metric-bar">
                                                <div class="metric-progress" id="productivityBar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div class="metric-card">
                                            <div class="metric-header">
                                                <span class="metric-icon">üéØ</span>
                                                <span class="metric-title">Task Completion Rate</span>
                                            </div>
                                            <div class="metric-value" id="taskCompletionRate">0%</div>
                                            <div class="metric-bar">
                                                <div class="metric-progress" id="taskCompletionBar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div class="metric-card">
                                            <div class="metric-header">
                                                <span class="metric-icon">‚è±Ô∏è</span>
                                                <span class="metric-title">Average Session Length</span>
                                            </div>
                                            <div class="metric-value" id="avgSessionLength">0h</div>
                                            <div class="metric-bar">
                                                <div class="metric-progress" id="sessionLengthBar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payroll Tab -->
                            <div id="payroll-tab" class="dashboard-tab-panel">
                                <div class="payroll-overview">
                                    <h3>üí∞ Payroll Information</h3>
                                    <div class="payroll-summary">
                                        <div class="payroll-card">
                                            <h4>Current Period</h4>
                                            <div class="payroll-details">
                                                <div class="payroll-item">
                                                    <span>Regular Hours:</span>
                                                    <span id="regularHours">0h</span>
                                                </div>
                                                <div class="payroll-item">
                                                    <span>Overtime Hours:</span>
                                                    <span id="overtimeHours">0h</span>
                                                </div>
                                                <div class="payroll-item">
                                                    <span>Hourly Rate:</span>
                                                    <span id="hourlyRate">EGP 0</span>
                                                </div>
                                                <div class="payroll-item total">
                                                    <span>Total Earnings:</span>
                                                    <span id="totalEarnings">EGP 0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="filters-section" style="margin-bottom: 20px;">
                <div class="filter-group" style="flex: 1;">
                    <label class="filter-label">üîç Search Workers</label>
                    <input type="text" class="filter-input" id="workerSearchInput" placeholder="Search by name, email, department, or role..." oninput="searchWorkers()">
                </div>
                <div class="filter-group">
                    <button class="action-btn" onclick="clearSearch()" style="background: #6c757d;">Clear</button>
                </div>
            </div>

            <!-- HR Summary Stats -->
            <div class="worker-stats" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-number" id="presentToday">-</div>
                    <div class="stat-label">Present Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="absentToday">-</div>
                    <div class="stat-label">Absent Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lateToday">-</div>
                    <div class="stat-label">Late Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overtimeToday">-</div>
                    <div class="stat-label">Overtime Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgAttendanceRate">-</div>
                    <div class="stat-label">Attendance Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalPayrollHours">-</div>
                    <div class="stat-label">Payroll Hours</div>
                </div>
            </div>

            <!-- HR Alerts -->
            <div class="filters-section" style="background: rgba(220, 53, 69, 0.1); border-color: rgba(220, 53, 69, 0.3);">
                <h3 style="color: #dc3545; margin-bottom: 15px; width: 100%;">üö® HR Alerts & Notifications</h3>
                <div id="hrAlerts">
                    <div class="loading">Loading alerts...</div>
                </div>
            </div>

            <!-- HR Filters -->
            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Department</label>
                    <select class="filter-select" id="departmentFilter" onchange="applyHRFilters()">
                        <option value="">All Departments</option>
                        <option value="development">Development</option>
                        <option value="design">Design</option>
                        <option value="marketing">Marketing</option>
                        <option value="management">Management</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Employment Type</label>
                    <select class="filter-select" id="employmentFilter" onchange="applyHRFilters()">
                        <option value="">All Types</option>
                        <option value="full-time">Full-time</option>
                        <option value="part-time">Part-time</option>
                        <option value="contract">Contract</option>
                        <option value="intern">Intern</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <select class="filter-select" id="hrDateRange" onchange="applyHRFilters()">
                        <option value="today">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Report Type</label>
                    <select class="filter-select" id="hrReportType" onchange="applyHRFilters()">
                        <option value="attendance">Attendance Report</option>
                        <option value="productivity">Productivity Report</option>
                        <option value="payroll">Payroll Report</option>
                        <option value="compliance">Compliance Report</option>
                        <option value="penalties">üí∞ Penalties & Bonuses</option>
                    </select>
                </div>
            </div>

            <!-- HR Content Container -->
            <div class="workers-container" id="hrContainer">
                <div class="loading">Loading HR data...</div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Task</h2>
                <span class="close" onclick="closeModal('createTaskModal')">&times;</span>
            </div>
            <form class="modal-form" id="createTaskForm">
                <div class="form-group">
                    <label class="form-label">Task Title *</label>
                    <input type="text" class="form-input" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-textarea" id="taskDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="taskProject">
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned To</label>
                    <select class="form-select" id="taskAssignedTo">
                        <option value="">Select Worker</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="taskPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="taskDueDate">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('createTaskModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Task Modal -->
    <div id="assignTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Task to Worker</h2>
                <span class="close" onclick="closeModal('assignTaskModal')">&times;</span>
            </div>
            <form class="modal-form" id="assignTaskForm">
                <div class="form-group">
                    <label class="form-label">Select Worker</label>
                    <select class="form-select" id="assignWorkerId" required>
                        <option value="">Choose a worker</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Task Title *</label>
                    <input type="text" class="form-input" id="assignTaskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-textarea" id="assignTaskDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="assignTaskProject">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="assignTaskPriority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="assignTaskDueDate">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('assignTaskModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Assign Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Task</h2>
                <span class="close" onclick="closeModal('editTaskModal')">&times;</span>
            </div>
            <form class="modal-form" id="editTaskForm">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label class="form-label">Task Title *</label>
                    <input type="text" class="form-input" id="editTaskTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-textarea" id="editTaskDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="editTaskProject">
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned To</label>
                    <select class="form-select" id="editTaskAssignedTo">
                        <option value="">Select Worker</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editTaskStatus">
                        <option value="assigned">Assigned</option>
                        <option value="in-progress">In Progress</option>
                        <option value="pending-approval">Pending Approval</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="editTaskPriority">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-input" id="editTaskDueDate">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('editTaskModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Update Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allSubmissions = [];
        let filteredSubmissions = [];
        let unsubscribe = null;

        // Initialize Firebase real-time listener
        async function initializeFirebase() {
            try {
                if (!window.db) {
                    throw new Error('Firebase not initialized. Check your configuration.');
                }

                // Create query for submissions ordered by submission date
                const q = window.query(
                    window.collection(window.db, 'submissions'),
                    window.orderBy('submittedAt', 'desc')
                );

                // Set up real-time listener
                unsubscribe = window.onSnapshot(q, 
                    (querySnapshot) => {
                        console.log('Firebase query result:', querySnapshot.size, 'documents');
                        allSubmissions = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            console.log('Document data:', doc.id, data);
                            
                            // Ensure status field exists
                            if (!data.status) {
                                data.status = 'new';
                            }
                            
                            allSubmissions.push({
                                id: doc.id,
                                ...data,
                                // Convert Firestore timestamp to JavaScript date
                                submittedAt: data.submittedAt?.toDate?.() || data.timestamp?.toDate?.() || new Date(data.createdAt || Date.now())
                            });
                        });
                        
                        filteredSubmissions = [...allSubmissions];
                        console.log('All submissions loaded:', allSubmissions);
                        console.log('Filtered submissions:', filteredSubmissions);
                        updateStats();
                        renderSubmissions();
                        showNotification(`Updated: ${allSubmissions.length} submissions loaded`);
                    },
                    (error) => {
                        console.error('Error listening to submissions:', error);
                        // Don't show error message, just show no submissions state
                        allSubmissions = [];
                        filteredSubmissions = [];
                        updateStats();
                        renderNoSubmissions();
                    }
                );

                // Initialize today's work time
                updateTodayWorkTime();

            } catch (error) {
                console.error('Firebase initialization error:', error);
                // Don't show error message, just show no submissions state
                allSubmissions = [];
                filteredSubmissions = [];
                updateStats();
                renderNoSubmissions();
            }
        }

        // Show Firebase configuration error
        function showFirebaseError(error) {
            const container = document.getElementById('submissionsContainer');
            container.innerHTML = `
                <div class="no-submissions">
                    <div class="no-submissions-icon">üî•</div>
                    <div class="no-submissions-text">No submissions found</div>
                    <div class="no-submissions-subtitle">New project requests will appear here in real-time</div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,193,7,0.1); border-radius: 8px; border: 1px solid #ffc107;">
                        <strong>Note:</strong> If you're not seeing data, please check your Firebase Firestore security rules.
                    </div>
                </div>
            `;
        }

        // Update statistics
        function updateStats() {
            const today = new Date().toDateString();
            const newCount = allSubmissions.filter(s => s.status === 'new').length;
            const todayCount = allSubmissions.filter(s => {
                const submissionDate = s.submittedAt instanceof Date ? s.submittedAt : new Date(s.submittedAt);
                return submissionDate.toDateString() === today;
            }).length;

            document.getElementById('totalSubmissions').textContent = allSubmissions.length;
            document.getElementById('newSubmissions').textContent = newCount;
            document.getElementById('todaySubmissions').textContent = todayCount;
        }

        // Format date
        function formatDate(date) {
            if (!date) return 'Unknown date';
            const d = date instanceof Date ? date : new Date(date);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
        }

        // Format date only (no time)
        function formatDateOnly(date) {
            if (!date) return 'Not specified';
            const d = date instanceof Date ? date : new Date(date);
            return d.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Format budget
        function formatBudget(budget) {
            const budgetMap = {
                'under-5k': 'Under $5K',
                '5k-15k': '$5K - $15K',
                '15k-50k': '$15K - $50K',
                'over-50k': '$50K+'
            };
            return budgetMap[budget] || budget;
        }

        // Format timeline
        function formatTimeline(timeline) {
            const timelineMap = {
                'asap': 'ASAP',
                '1-month': '1 Month',
                '2-3-months': '2-3 Months',
                '3-6-months': '3-6 Months',
                'flexible': 'Flexible'
            };
            return timelineMap[timeline] || timeline;
        }

        // Format service name
        function formatServiceName(service) {
            const serviceMap = {
                'branding': 'Branding & Identity',
                'media-buying': 'Media Buying',
                'digital-marketing': 'Digital Marketing',
                'media-production': 'Media Production',
                'outdoor-advertising': 'Outdoor Advertising',
                'web-development': 'Web & SEO Development',
                'printing': 'Printing Solutions',
                'event-management': 'Event Management'
            };
            return serviceMap[service] || service;
        }

        // Format time
        function formatTime(time) {
            if (!time) return 'Not specified';
            const [hour, minute] = time.split(':');
            const hourNum = parseInt(hour);
            const ampm = hourNum >= 12 ? 'PM' : 'AM';
            const displayHour = hourNum % 12 || 12;
            return `${displayHour}:${minute} ${ampm}`;
        }

        // Render submissions
        function renderSubmissions() {
            const container = document.getElementById('submissionsContainer');
            
            if (filteredSubmissions.length === 0) {
                renderNoSubmissions();
                return;
            }

            container.innerHTML = filteredSubmissions.map(submission => `
                <div class="submission-card ${submission.status === 'new' ? 'new' : ''}" data-id="${submission.id}">
                    <div class="submission-header">
                        <div class="client-info">
                            <div class="client-name">${submission.fullName}</div>
                            <div class="client-email">üìß ${submission.email}</div>
                            ${submission.phone ? `<div class="client-company">üìû ${submission.phone}</div>` : ''}
                            ${submission.company ? `<div class="client-company">üè¢ ${submission.company}</div>` : ''}
                        </div>
                        <div class="submission-meta">
                            <div class="submission-date">${formatDate(submission.submittedAt)}</div>
                            <div class="submission-id">ID: ${submission.id.slice(-8)}</div>
                            <div style="margin-top: 5px;">
                                <span class="status-badge status-${submission.status}">${submission.status}</span>
                            </div>
                        </div>
                    </div>

                    <div class="project-details">
                        <div class="detail-group">
                            <div class="detail-label">Meeting Schedule</div>
                            <div class="detail-value">
                                üìÖ ${formatDateOnly(submission.meetingDate)} at ${formatTime(submission.meetingTime)}
                            </div>
                        </div>
                        ${submission.meetingEmail ? `
                        <div class="detail-group">
                            <div class="detail-label">Meeting Email</div>
                            <div class="detail-value">üìß ${submission.meetingEmail}</div>
                        </div>
                        ` : ''}
                    </div>

                    ${submission.services && Array.isArray(submission.services) && submission.services.length > 0 ? `
                    <div class="detail-group" style="margin-bottom: 20px;">
                        <div class="detail-label">Requested Services</div>
                        <div class="services-list">
                            ${submission.services.map(service => `<span class="service-tag">${formatServiceName(service)}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="project-description">
                        <div class="description-label">Project Description</div>
                        <div class="description-text">${submission.projectDescription}</div>
                    </div>

                    ${submission.referenceLinks ? `
                    <div class="project-description" style="margin-bottom: 20px;">
                        <div class="description-label">Reference Links</div>
                        <div class="description-text">${submission.referenceLinks}</div>
                    </div>
                    ` : ''}

                    <div class="submission-actions">
                        <button class="action-btn btn-contact" onclick="contactClient('${submission.email}', '${submission.fullName}')">
                            üìß Contact Client
                        </button>
                        <button class="action-btn btn-status" onclick="updateStatus('${submission.id}', 'contacted')">
                            ‚úÖ Mark Contacted
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteSubmission('${submission.id}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    
                    <div class="phase-management">
                        <div class="phase-header">
                            <h4>Project Phases</h4>
                        </div>
                        <div class="phase-controls">
                            <div class="phase-item ${submission.phase1Status || 'pending'}">
                                <span class="phase-label">Phase 1: Planning</span>
                                <div class="phase-buttons">
                                    <button class="phase-btn btn-start" onclick="updatePhase('${submission.id}', 'phase1', 'in-progress')" ${submission.phase1Status === 'in-progress' || submission.phase1Status === 'completed' ? 'disabled' : ''}>
                                        üöÄ Start
                                    </button>
                                    <button class="phase-btn btn-complete" onclick="updatePhase('${submission.id}', 'phase1', 'completed')" ${submission.phase1Status !== 'in-progress' ? 'disabled' : ''}>
                                        ‚úÖ Complete
                                    </button>
                                </div>
                            </div>
                            <div class="phase-item ${submission.phase2Status || 'pending'}">
                                <span class="phase-label">Phase 2: Development</span>
                                <div class="phase-buttons">
                                    <button class="phase-btn btn-start" onclick="updatePhase('${submission.id}', 'phase2', 'in-progress')" ${submission.phase1Status !== 'completed' || submission.phase2Status === 'in-progress' || submission.phase2Status === 'completed' ? 'disabled' : ''}>
                                        üöÄ Start
                                    </button>
                                    <button class="phase-btn btn-complete" onclick="updatePhase('${submission.id}', 'phase2', 'completed')" ${submission.phase2Status !== 'in-progress' ? 'disabled' : ''}>
                                        ‚úÖ Complete
                                    </button>
                                </div>
                            </div>
                            <div class="phase-item ${submission.phase3Status || 'pending'}">
                                <span class="phase-label">Phase 3: Finalization</span>
                                <div class="phase-buttons">
                                    <button class="phase-btn btn-start" onclick="updatePhase('${submission.id}', 'phase3', 'in-progress')" ${submission.phase2Status !== 'completed' || submission.phase3Status === 'in-progress' || submission.phase3Status === 'completed' ? 'disabled' : ''}>
                                        üöÄ Start
                                    </button>
                                    <button class="phase-btn btn-complete" onclick="updatePhase('${submission.id}', 'phase3', 'completed')" ${submission.phase3Status !== 'in-progress' ? 'disabled' : ''}>
                                        ‚úÖ Complete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render no submissions state
        function renderNoSubmissions() {
            const container = document.getElementById('submissionsContainer');
            container.innerHTML = `
                <div class="no-submissions">
                    <div class="no-submissions-icon">üî•</div>
                    <div class="no-submissions-text">No submissions found</div>
                    <div class="no-submissions-subtitle">New project requests will appear here in real-time</div>
                </div>
            `;
        }

        // Apply filters
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredSubmissions = allSubmissions.filter(submission => {
                const matchesStatus = !statusFilter || submission.status === statusFilter;
                const matchesService = !serviceFilter || (submission.services && Array.isArray(submission.services) && submission.services.includes(serviceFilter));
                const matchesDate = !dateFilter || checkDateFilter(submission.meetingDate, dateFilter);
                const matchesSearch = !searchFilter || 
                    submission.fullName.toLowerCase().includes(searchFilter) ||
                    submission.email.toLowerCase().includes(searchFilter) ||
                    (submission.company && submission.company.toLowerCase().includes(searchFilter));

                return matchesStatus && matchesService && matchesDate && matchesSearch;
            });

            renderSubmissions();
        }

        // Check date filter
        function checkDateFilter(meetingDate, filter) {
            if (!meetingDate) return false;
            
            const meetingDateObj = new Date(meetingDate);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            switch(filter) {
                case 'today':
                    return meetingDateObj.toDateString() === today.toDateString();
                case 'tomorrow':
                    return meetingDateObj.toDateString() === tomorrow.toDateString();
                case 'this-week':
                    const thisWeekStart = new Date(today);
                    thisWeekStart.setDate(today.getDate() - today.getDay());
                    const thisWeekEnd = new Date(thisWeekStart);
                    thisWeekEnd.setDate(thisWeekStart.getDate() + 6);
                    return meetingDateObj >= thisWeekStart && meetingDateObj <= thisWeekEnd;
                case 'next-week':
                    const nextWeekStart = new Date(today);
                    nextWeekStart.setDate(today.getDate() - today.getDay() + 7);
                    const nextWeekEnd = new Date(nextWeekStart);
                    nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
                    return meetingDateObj >= nextWeekStart && meetingDateObj <= nextWeekEnd;
                case 'this-month':
                    return meetingDateObj.getMonth() === today.getMonth() && 
                           meetingDateObj.getFullYear() === today.getFullYear();
                default:
                    return true;
            }
        }

        // Contact client
        function contactClient(email, name) {
            const subject = encodeURIComponent(`Re: Your Project Request - Monkeys Have Fallen The Tree`);
            const body = encodeURIComponent(`Hi ${name},\n\nThank you for your project request. We've reviewed your requirements and would love to discuss your project in more detail.\n\nBest regards,\nMonkeys Have Fallen The Tree Team`);
            
            window.open(`mailto:${email}?subject=${subject}&body=${body}`);
        }

        // Update submission status
        async function updateStatus(id, status) {
            try {
                await window.updateDoc(window.doc(window.db, 'submissions', id), {
                    status: status,
                    updatedAt: new Date().toISOString()
                });
                showNotification(`Status updated to: ${status}`);
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status: ' + error.message);
            }
        }

        // Update project phase
        async function updatePhase(id, phase, status) {
            try {
                const updateData = {
                    [phase + 'Status']: status,
                    [phase + 'UpdatedAt']: new Date().toISOString()
                };

                // If completing a phase, also update the overall project status
                if (status === 'completed') {
                    updateData.updatedAt = new Date().toISOString();
                    
                    // Check if all phases are completed
                    const submission = allSubmissions.find(s => s.id === id);
                    if (submission) {
                        const phase1Completed = phase === 'phase1' ? true : (submission.phase1Status === 'completed');
                        const phase2Completed = phase === 'phase2' ? true : (submission.phase2Status === 'completed');
                        const phase3Completed = phase === 'phase3' ? true : (submission.phase3Status === 'completed');
                        
                        if (phase1Completed && phase2Completed && phase3Completed) {
                            updateData.status = 'completed';
                            updateData.completedAt = new Date().toISOString();
                        }
                    }
                }

                await window.updateDoc(window.doc(window.db, 'submissions', id), updateData);
                showNotification(`Phase ${phase.charAt(5)} ${status === 'in-progress' ? 'started' : 'completed'}`);
            } catch (error) {
                console.error('Error updating phase:', error);
                alert('Error updating phase: ' + error.message);
            }
        }

        // Delete submission
        async function deleteSubmission(id) {
            if (confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'submissions', id));
                    showNotification('Submission deleted successfully');
                } catch (error) {
                    console.error('Error deleting submission:', error);
                    alert('Error deleting submission: ' + error.message);
                }
            }
        }

        // Manual refresh
        function manualRefresh() {
            // Firebase real-time listener handles updates automatically
            showNotification('Real-time updates are active - no manual refresh needed!');
        }

        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Check admin authentication using Firebase Auth
        function checkAdminAuth() {
            return new Promise((resolve) => {
                const unsubscribe = window.onAuthStateChanged(window.auth, (user) => {
                    unsubscribe();
                    
                                    if (!user || user.email !== 'admin@mft.com') {
                    alert('Please login as admin first.');
                    window.location.href = 'index.html';
                    resolve(false);
                    return;
                }
                    
                    resolve(true);
                });
            });
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = 'index.html';
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const isAuthenticated = await checkAdminAuth();
            if (!isAuthenticated) {
                return;
            }
            
            // Add small delay to ensure Firebase is loaded
            setTimeout(() => {
                initializeFirebase();
                
                // Refresh worker data every 30 seconds to keep online status current
                setInterval(() => {
                    loadWorkers();
                    updateTodayWorkTime(); // Also refresh today's work time
                }, 30000);
            }, 1000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // Global variables for workers and tasks
        let allWorkers = [];
        let allTasks = [];
        let allWorkSessions = [];
        let filteredWorkSessions = [];

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Load data for the selected tab
            if (tabName === 'workers') {
                loadWorkers();
            } else if (tabName === 'tasks') {
                loadTasks();
            } else if (tabName === 'worksessions') {
                loadWorkSessions();
            } else if (tabName === 'hr') {
                loadHRDashboard();
            }
        }

        function showError(message) {
            // Create error notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                max-width: 300px;
                border: 1px solid #c82333;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds (longer for errors)
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Load workers
        async function loadWorkers() {
            try {
                const workersContainer = document.getElementById('workersContainer');
                workersContainer.innerHTML = '<div class="loading">Loading workers...</div>';

                const q = window.query(window.collection(window.db, 'workers'));
                const querySnapshot = await window.getDocs(q);
                
                allWorkers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allWorkers.push({
                        id: doc.id,
                        ...data
                    });
                });

                renderWorkers();
                updateStats();
            } catch (error) {
                console.error('Error loading workers:', error);
                document.getElementById('workersContainer').innerHTML = 
                    '<div style="color: #ff4757; text-align: center; padding: 20px;">Error loading workers</div>';
            }
        }

        // Render workers
        function renderWorkers() {
            const workersContainer = document.getElementById('workersContainer');
            const workerCountElement = document.getElementById('workerCount');
            
            // Update worker count display
            const statusCounts = {
                approved: allWorkers.filter(w => w.status === 'approved').length,
                pending: allWorkers.filter(w => w.status === 'pending').length,
                rejected: allWorkers.filter(w => w.status === 'rejected').length,
                online: allWorkers.filter(w => w.isOnline).length
            };
            
            workerCountElement.innerHTML = `
                üìä Total: ${allWorkers.length} | 
                ‚úÖ Approved: ${statusCounts.approved} | 
                ‚è≥ Pending: ${statusCounts.pending} | 
                ‚ùå Rejected: ${statusCounts.rejected} | 
                üü¢ Online: ${statusCounts.online}
            `;
            
            if (allWorkers.length === 0) {
                workersContainer.innerHTML = `
                    <div style="text-align: center; color: #888888; padding: 40px;">
                        <p>No workers found.</p>
                        <p>Workers will appear here when they register.</p>
                    </div>
                `;
                return;
            }

            workersContainer.innerHTML = allWorkers.map(worker => `
                <div class="worker-card">
                    <div class="worker-header">
                        <div class="worker-name">${worker.firstName} ${worker.lastName}</div>
                        <div class="worker-role">${formatRole(worker.role)}</div>
                    </div>
                    <div class="worker-details">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üìã Basic Information</h4>
                                <strong>Email:</strong> ${worker.email}<br>
                                <strong>Phone:</strong> ${worker.phone}<br>
                                <strong>Role:</strong> ${formatRole(worker.role)}<br>
                                <strong>Experience:</strong> ${worker.experience || 'N/A'}<br>
                                <strong>Department:</strong> ${worker.department || 'N/A'}<br>
                                <strong>Work Type:</strong> ${formatWorkType(worker.employmentType)}<br>
                                <strong>Expected Salary:</strong> ${worker.expectedSalary ? `EGP ${worker.expectedSalary}` : 'Not set'}
                            </div>
                            
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üí∞ Compensation & Skills</h4>
                                <strong>Skills:</strong> ${worker.skills && worker.skills.length > 0 ? worker.skills.join(', ') : 'Not specified'}<br>
                                <strong>Status:</strong> <span class="status-badge status-${worker.status}">${worker.status.toUpperCase()}</span><br>
                                <strong>Online Status:</strong> <span class="status-badge ${worker.isOnline ? 'online' : 'offline'}">${worker.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                            </div>
                            
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üìç Location & Contact</h4>
                                <strong>Government:</strong> ${worker.government || 'N/A'}<br>
                                <strong>City:</strong> ${worker.city || 'N/A'}<br>
                                <strong>Portfolio:</strong> ${worker.portfolioLink ? `<a href="${worker.portfolioLink}" target="_blank" style="color: #ef414b;">View Portfolio</a>` : 'Not provided'}<br>
                                <strong>Time to Leave Current Job:</strong> ${worker.netspend || 'Not specified'}
                            </div>
                            
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üìÖ Timeline</h4>
                                <strong>Joined:</strong> ${worker.createdAt ? new Date(worker.createdAt.toDate()).toLocaleDateString() : 'N/A'}<br>
                                <strong>Last Login:</strong> ${worker.lastLogin ? new Date(worker.lastLogin.toDate()).toLocaleString() : 'N/A'}<br>
                                <strong>Last Logout:</strong> ${worker.lastLogout ? new Date(worker.lastLogout.toDate()).toLocaleString() : 'Never'}<br>
                                <strong>Tasks Completed:</strong> ${worker.completedTasks || 0}/${worker.totalTasks || 0}
                            </div>
                        </div>
                    </div>
                    <div class="worker-actions">
                        ${worker.status === 'pending' ? `
                            <button class="worker-btn btn-approve" onclick="approveWorker('${worker.id}')">
                                Approve
                            </button>
                            <button class="worker-btn btn-reject" onclick="rejectWorker('${worker.id}')">
                                Reject
                            </button>
                        ` : ''}
                        <button class="worker-btn btn-assign" onclick="showAssignTaskModal('${worker.id}')">
                            Assign Task
                        </button>
                        <button class="worker-btn btn-view" onclick="viewWorkerDetails('${worker.id}')">
                            View Details
                        </button>
                        <button class="worker-btn btn-delete" onclick="deleteWorker('${worker.id}', '${worker.firstName} ${worker.lastName}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Filter workers
        function filterWorkers() {
            const searchTerm = document.getElementById('workerSearchFilter').value.toLowerCase();
            const statusFilter = document.getElementById('workerStatusFilter').value;
            const roleFilter = document.getElementById('workerRoleFilter').value;

            const filteredWorkers = allWorkers.filter(worker => {
                const matchesSearch = !searchTerm || 
                    `${worker.firstName} ${worker.lastName}`.toLowerCase().includes(searchTerm) ||
                    worker.email.toLowerCase().includes(searchTerm) ||
                    worker.role.toLowerCase().includes(searchTerm);

                const matchesStatus = !statusFilter || worker.status === statusFilter;
                const matchesRole = !roleFilter || worker.role === roleFilter;

                return matchesSearch && matchesStatus && matchesRole;
            });

            renderFilteredWorkers(filteredWorkers);
        }

        // Clear worker filters
        function clearWorkerFilters() {
            document.getElementById('workerSearchFilter').value = '';
            document.getElementById('workerStatusFilter').value = '';
            document.getElementById('workerRoleFilter').value = '';
            renderWorkers();
        }

        // Render filtered workers
        function renderFilteredWorkers(workers) {
            const workersContainer = document.getElementById('workersContainer');
            const workerCountElement = document.getElementById('workerCount');
            
            // Update worker count display with filtered results
            const statusCounts = {
                approved: workers.filter(w => w.status === 'approved').length,
                pending: workers.filter(w => w.status === 'pending').length,
                rejected: workers.filter(w => w.status === 'rejected').length,
                online: workers.filter(w => w.isOnline).length
            };
            
            const totalOriginal = allWorkers.length;
            const totalFiltered = workers.length;
            
            workerCountElement.innerHTML = `
                üìä Showing: ${totalFiltered}/${totalOriginal} | 
                ‚úÖ Approved: ${statusCounts.approved} | 
                ‚è≥ Pending: ${statusCounts.pending} | 
                ‚ùå Rejected: ${statusCounts.rejected} | 
                üü¢ Online: ${statusCounts.online}
            `;
            
            if (workers.length === 0) {
                workersContainer.innerHTML = `
                    <div style="text-align: center; color: #888888; padding: 40px;">
                        <p>No workers match the current filters.</p>
                        <p>Try adjusting your search criteria or clearing the filters.</p>
                    </div>
                `;
                return;
            }

            workersContainer.innerHTML = workers.map(worker => `
                <div class="worker-card">
                    <div class="worker-header">
                        <div class="worker-name">${worker.firstName} ${worker.lastName}</div>
                        <div class="worker-role">${formatRole(worker.role)}</div>
                    </div>
                    <div class="worker-details">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üìã Basic Information</h4>
                                <strong>Email:</strong> ${worker.email}<br>
                                <strong>Phone:</strong> ${worker.phone}<br>
                                <strong>Role:</strong> ${formatRole(worker.role)}<br>
                                <strong>Experience:</strong> ${worker.experience || 'N/A'}<br>
                                <strong>Department:</strong> ${worker.department || 'N/A'}<br>
                                <strong>Work Type:</strong> ${formatWorkType(worker.employmentType)}<br>
                                <strong>Expected Salary:</strong> ${worker.expectedSalary ? `EGP ${worker.expectedSalary}` : 'Not set'}
                            </div>
                            
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üí∞ Compensation & Skills</h4>
                                <strong>Skills:</strong> ${worker.skills && worker.skills.length > 0 ? worker.skills.join(', ') : 'Not specified'}<br>
                                <strong>Status:</strong> <span class="status-badge status-${worker.status}">${worker.status.toUpperCase()}</span><br>
                                <strong>Online Status:</strong> <span class="status-badge ${worker.isOnline ? 'online' : 'offline'}">${worker.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                            </div>
                            
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üìç Location & Contact</h4>
                                <strong>Government:</strong> ${worker.government || 'N/A'}<br>
                                <strong>City:</strong> ${worker.city || 'N/A'}<br>
                                <strong>Portfolio:</strong> ${worker.portfolioLink ? `<a href="${worker.portfolioLink}" target="_blank" style="color: #ef414b;">View Portfolio</a>` : 'Not provided'}<br>
                                <strong>Netspend:</strong> ${worker.netspend || 'Not provided'}
                            </div>
                            
                            <div class="worker-info-section">
                                <h4 style="color: #ef414b; margin-bottom: 10px; font-size: 0.9rem;">üìÖ Timeline</h4>
                                <strong>Joined:</strong> ${worker.createdAt ? new Date(worker.createdAt.toDate()).toLocaleDateString() : 'N/A'}<br>
                                <strong>Last Login:</strong> ${worker.lastLogin ? new Date(worker.lastLogin.toDate()).toLocaleString() : 'N/A'}<br>
                                <strong>Last Logout:</strong> ${worker.lastLogout ? new Date(worker.lastLogout.toDate()).toLocaleString() : 'Never'}<br>
                                <strong>Tasks Completed:</strong> ${worker.completedTasks || 0}/${worker.totalTasks || 0}
                            </div>
                        </div>
                    </div>
                    <div class="worker-actions">
                        ${worker.status === 'pending' ? `
                            <button class="worker-btn btn-approve" onclick="approveWorker('${worker.id}')">
                                Approve
                            </button>
                            <button class="worker-btn btn-reject" onclick="rejectWorker('${worker.id}')">
                                Reject
                            </button>
                        ` : ''}
                        <button class="worker-btn btn-assign" onclick="showAssignTaskModal('${worker.id}')">
                            Assign Task
                        </button>
                        <button class="worker-btn btn-view" onclick="viewWorkerDetails('${worker.id}')">
                            View Details
                        </button>
                        <button class="worker-btn btn-delete" onclick="deleteWorker('${worker.id}', '${worker.firstName} ${worker.lastName}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load tasks
        async function loadTasks() {
            try {
                const tasksContainer = document.getElementById('tasksContainer');
                tasksContainer.innerHTML = '<div class="loading">Loading tasks...</div>';

                const q = window.query(window.collection(window.db, 'tasks'), window.orderBy('createdAt', 'desc'));
                const querySnapshot = await window.getDocs(q);
                
                allTasks = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allTasks.push({
                        id: doc.id,
                        ...data
                    });
                });

                renderTasks();
                updateStats();
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasksContainer').innerHTML = 
                    '<div style="color: #ff4757; text-align: center; padding: 20px;">Error loading tasks</div>';
            }
        }

        // Render tasks
        function renderTasks() {
            const tasksContainer = document.getElementById('tasksContainer');
            
            if (allTasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div style="text-align: center; color: #888888; padding: 40px;">
                        <p>No tasks found.</p>
                        <p>Tasks will appear here when created.</p>
                    </div>
                `;
                return;
            }

            tasksContainer.innerHTML = allTasks.map(task => `
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">${task.title}</div>
                        <div class="task-status ${task.status.replace('-', '')}">${task.status.replace('-', ' ').toUpperCase()}</div>
                    </div>
                    <div class="task-details">
                        <strong>Description:</strong> ${task.description}<br>
                        <strong>Project:</strong> ${task.projectName || 'N/A'}<br>
                        <strong>Priority:</strong> ${task.priority}<br>
                        <strong>Assigned To:</strong> ${getWorkerName(task.assignedTo)}<br>
                        <strong>Due Date:</strong> ${task.dueDate ? new Date(task.dueDate.toDate()).toLocaleDateString() : 'No due date'}<br>
                        <strong>Created:</strong> ${task.createdAt ? new Date(task.createdAt.toDate()).toLocaleDateString() : 'N/A'}
                    </div>
                    <div class="task-actions">
                        <button class="task-btn btn-view" onclick="viewTaskDetails('${task.id}')">
                            View Details
                        </button>
                        <button class="task-btn btn-assign" onclick="editTask('${task.id}')">
                            Edit Task
                        </button>
                        <button class="task-btn btn-delete" onclick="deleteTask('${task.id}')" style="background: #dc3545; color: white;">
                            üóëÔ∏è Delete
                        </button>
                        ${task.status === 'pending-approval' ? `
                            <button class="task-btn btn-approve" onclick="approveTask('${task.id}')" style="background: #28a745; color: white;">
                                ‚úÖ Approve
                            </button>
                            <button class="task-btn btn-reject" onclick="rejectTask('${task.id}')" style="background: #dc3545; color: white;">
                                ‚ùå Reject
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalSubmissions').textContent = allSubmissions.length;
            document.getElementById('totalWorkers').textContent = allWorkers.length;
            document.getElementById('totalTasks').textContent = allTasks.length;
            
            const pendingWorkers = allWorkers.filter(worker => worker.status === 'pending').length;
            document.getElementById('pendingApprovals').textContent = pendingWorkers;
            
            const onlineWorkers = allWorkers.filter(worker => worker.isOnline === true).length;
            document.getElementById('onlineWorkers').textContent = onlineWorkers;
            
            // Calculate today's total work time
            updateTodayWorkTime();
        }

        // Calculate and update today's total work time
        async function updateTodayWorkTime() {
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Get today's work sessions
                const q = window.query(
                    window.collection(window.db, 'workSessions'),
                    window.where('date', '==', today)
                );
                const querySnapshot = await window.getDocs(q);
                
                let totalTodayWorkTime = 0;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.totalWorkTime) {
                        totalTodayWorkTime += data.totalWorkTime;
                    }
                });

                const todayHours = Math.round(totalTodayWorkTime / (1000 * 60 * 60) * 10) / 10;
                document.getElementById('todayWorkTime').textContent = `${todayHours}h`;
                
            } catch (error) {
                console.error('Error calculating today\'s work time:', error);
                document.getElementById('todayWorkTime').textContent = '0h';
            }
        }

        // Format role for display
        function formatRole(role) {
            return role.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Format work type for display
        function formatWorkType(workType) {
            if (!workType) return 'N/A';
            return workType.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Get worker name by ID
        function getWorkerName(workerId) {
            const worker = allWorkers.find(w => w.id === workerId);
            return worker ? `${worker.firstName} ${worker.lastName}` : 'Unassigned';
        }

        // Approve worker
        async function approveWorker(workerId) {
            try {
                await window.updateDoc(window.doc(window.db, 'workers', workerId), {
                    status: 'approved'
                });
                showNotification('Worker approved successfully!');
                loadWorkers();
            } catch (error) {
                console.error('Error approving worker:', error);
                alert('Error approving worker. Please try again.');
            }
        }

        // Reject worker
        async function rejectWorker(workerId) {
            try {
                await window.updateDoc(window.doc(window.db, 'workers', workerId), {
                    status: 'rejected'
                });
                showNotification('Worker rejected successfully!');
                loadWorkers();
            } catch (error) {
                console.error('Error rejecting worker:', error);
                alert('Error rejecting worker. Please try again.');
            }
        }

        // Delete worker
        async function deleteWorker(workerId, workerName) {
            const confirmation = confirm(`‚ö†Ô∏è DELETE WORKER\n\nAre you sure you want to permanently delete "${workerName}"?\n\nThis will also delete:\n- All work sessions\n- All assigned tasks\n- All exception requests\n- All alert history\n\nThis action CANNOT be undone!`);
            
            if (!confirmation) return;

            const secondConfirmation = confirm(`üö® FINAL CONFIRMATION\n\nType "DELETE" in the next prompt to confirm deletion of "${workerName}".`);
            if (!secondConfirmation) return;

            const finalConfirm = prompt(`To permanently delete "${workerName}", type: DELETE`);
            if (finalConfirm !== 'DELETE') {
                alert('Deletion cancelled. Must type "DELETE" exactly.');
                return;
            }

            try {
                showNotification('Deleting worker and related data...');

                // Delete worker's work sessions
                const workSessionsQuery = window.query(
                    window.collection(window.db, 'workSessions'),
                    window.where('workerId', '==', workerId)
                );
                const workSessionsSnapshot = await window.getDocs(workSessionsQuery);
                const workSessionDeletes = workSessionsSnapshot.docs.map(doc => 
                    window.deleteDoc(window.doc(window.db, 'workSessions', doc.id))
                );

                // Delete worker's tasks
                const tasksQuery = window.query(
                    window.collection(window.db, 'tasks'),
                    window.where('assignedTo', '==', workerId)
                );
                const tasksSnapshot = await window.getDocs(tasksQuery);
                const taskDeletes = tasksSnapshot.docs.map(doc => 
                    window.deleteDoc(window.doc(window.db, 'tasks', doc.id))
                );

                // Delete worker's exception requests
                const exceptionsQuery = window.query(
                    window.collection(window.db, 'exceptionRequests'),
                    window.where('workerId', '==', workerId)
                );
                const exceptionsSnapshot = await window.getDocs(exceptionsQuery);
                const exceptionDeletes = exceptionsSnapshot.docs.map(doc => 
                    window.deleteDoc(window.doc(window.db, 'exceptionRequests', doc.id))
                );

                // Delete alerts where worker is recipient
                const alertsQuery = window.query(window.collection(window.db, 'alerts'));
                const alertsSnapshot = await window.getDocs(alertsQuery);
                const alertDeletes = alertsSnapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return data.recipients && data.recipients.includes(workerId);
                    })
                    .map(doc => {
                        const data = doc.data();
                        const updatedRecipients = data.recipients.filter(id => id !== workerId);
                        if (updatedRecipients.length === 0) {
                            // Delete alert if no recipients left
                            return window.deleteDoc(window.doc(window.db, 'alerts', doc.id));
                        } else {
                            // Update alert with remaining recipients
                            return window.updateDoc(window.doc(window.db, 'alerts', doc.id), {
                                recipients: updatedRecipients
                            });
                        }
                    });

                // Execute all deletions in parallel
                await Promise.all([
                    ...workSessionDeletes,
                    ...taskDeletes,
                    ...exceptionDeletes,
                    ...alertDeletes
                ]);

                // Finally, delete the worker document
                await window.deleteDoc(window.doc(window.db, 'workers', workerId));

                showNotification(`Worker "${workerName}" and all related data deleted successfully!`);
                loadWorkers(); // Refresh the workers list

                // If on HR tab, refresh HR data too
                const currentTab = document.querySelector('.nav-tab.active');
                if (currentTab && currentTab.id === 'tab-hr') {
                    loadHRDashboard();
                }

            } catch (error) {
                console.error('Error deleting worker:', error);
                alert(`Error deleting worker: ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        // Approve task completion
        async function approveTask(taskId) {
            try {
                await window.updateDoc(window.doc(window.db, 'tasks', taskId), {
                    status: 'completed',
                    approvedAt: window.serverTimestamp(),
                    approvedBy: 'admin'
                });
                showNotification('Task approved successfully!');
                loadTasks();
            } catch (error) {
                console.error('Error approving task:', error);
                alert('Error approving task. Please try again.');
            }
        }

        // Reject task completion
        async function rejectTask(taskId) {
            try {
                await window.updateDoc(window.doc(window.db, 'tasks', taskId), {
                    status: 'in-progress',
                    rejectedAt: window.serverTimestamp(),
                    rejectedBy: 'admin',
                    rejectionReason: prompt('Please provide a reason for rejection (optional):') || 'No reason provided'
                });
                showNotification('Task rejected. Worker will be notified to make changes.');
                loadTasks();
            } catch (error) {
                console.error('Error rejecting task:', error);
                alert('Error rejecting task. Please try again.');
            }
        }

        // Show create task modal
        function showCreateTaskModal() {
            populateWorkerSelect('taskAssignedTo');
            document.getElementById('createTaskModal').style.display = 'block';
        }

        // Show assign task modal
        function showAssignTaskModal(workerId = null) {
            populateWorkerSelect('assignWorkerId');
            if (workerId) {
                document.getElementById('assignWorkerId').value = workerId;
            }
            document.getElementById('assignTaskModal').style.display = 'block';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Reset form
            document.getElementById(modalId).querySelector('form').reset();
        }

        // Populate worker select dropdown
        function populateWorkerSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Worker</option>';
            
            const approvedWorkers = allWorkers.filter(worker => worker.status === 'approved');
            approvedWorkers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.firstName} ${worker.lastName} (${formatRole(worker.role)})`;
                select.appendChild(option);
            });
        }

        // Create task
        async function createTask(taskData) {
            try {
                const task = {
                    ...taskData,
                    status: 'assigned',
                    createdAt: window.serverTimestamp(),
                    assignedAt: window.serverTimestamp()
                };

                await window.addDoc(window.collection(window.db, 'tasks'), task);
                showNotification('Task created successfully!');
                closeModal('createTaskModal');
                loadTasks();
            } catch (error) {
                console.error('Error creating task:', error);
                alert('Error creating task. Please try again.');
            }
        }

        // Handle create task form submission
        document.getElementById('createTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                projectName: document.getElementById('taskProject').value,
                assignedTo: document.getElementById('taskAssignedTo').value,
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value ? new Date(document.getElementById('taskDueDate').value) : null
            };

            await createTask(taskData);
        });

        // Handle assign task form submission
        document.getElementById('assignTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const taskData = {
                title: document.getElementById('assignTaskTitle').value,
                description: document.getElementById('assignTaskDescription').value,
                projectName: document.getElementById('assignTaskProject').value,
                assignedTo: document.getElementById('assignWorkerId').value,
                priority: document.getElementById('assignTaskPriority').value,
                dueDate: document.getElementById('assignTaskDueDate').value ? new Date(document.getElementById('assignTaskDueDate').value) : null
            };

            await createTask(taskData);
        });

        // View worker details
        function viewWorkerDetails(workerId) {
            const worker = allWorkers.find(w => w.id === workerId);
            if (worker) {
                const details = `
WORKER DETAILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã BASIC INFORMATION:
‚Ä¢ Name: ${worker.firstName} ${worker.lastName}
‚Ä¢ Email: ${worker.email}
‚Ä¢ Phone: ${worker.phone}
‚Ä¢ Role: ${formatRole(worker.role)}
‚Ä¢ Experience: ${worker.experience || 'N/A'}
‚Ä¢ Department: ${worker.department || 'N/A'}
‚Ä¢ Employment Type: ${worker.employmentType || 'N/A'}
‚Ä¢ Expected Hours: ${worker.expectedHours || 'N/A'} hours/day

üí∞ COMPENSATION & SKILLS:
‚Ä¢ Hourly Rate: ${worker.hourlyRate ? `EGP ${worker.hourlyRate}` : 'Not set'}
‚Ä¢ Skills: ${worker.skills && worker.skills.length > 0 ? worker.skills.join(', ') : 'Not specified'}

üìû EMERGENCY CONTACT:
${worker.emergencyContact ? 
`‚Ä¢ Contact Name: ${worker.emergencyContact.name}
‚Ä¢ Contact Phone: ${worker.emergencyContact.phone}` : 
'‚Ä¢ No emergency contact provided'}

üìÖ TIMELINE & STATUS:
‚Ä¢ Status: ${worker.status.toUpperCase()}
‚Ä¢ Online Status: ${worker.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
‚Ä¢ Joined: ${worker.createdAt ? new Date(worker.createdAt.toDate()).toLocaleDateString() : 'N/A'}
‚Ä¢ Last Login: ${worker.lastLogin ? new Date(worker.lastLogin.toDate()).toLocaleString() : 'N/A'}
‚Ä¢ Last Logout: ${worker.lastLogout ? new Date(worker.lastLogout.toDate()).toLocaleString() : 'Never'}
‚Ä¢ Tasks Completed: ${worker.completedTasks || 0}/${worker.totalTasks || 0}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                `;
                alert(details);
            }
        }

        // View task details
        function viewTaskDetails(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (task) {
                const details = `
Task Details:
- Title: ${task.title}
- Description: ${task.description}
- Project: ${task.projectName || 'N/A'}
- Priority: ${task.priority}
- Status: ${task.status}
- Assigned To: ${getWorkerName(task.assignedTo)}
- Due Date: ${task.dueDate ? new Date(task.dueDate.toDate()).toLocaleDateString() : 'No due date'}
- Created: ${task.createdAt ? new Date(task.createdAt.toDate()).toLocaleDateString() : 'N/A'}
                `;
                alert(details);
            }
        }

        // Edit task
        function editTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) {
                alert('Task not found!');
                return;
            }
            
            // Populate the edit form with task data
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description;
            document.getElementById('editTaskProject').value = task.projectName || '';
            document.getElementById('editTaskStatus').value = task.status;
            document.getElementById('editTaskPriority').value = task.priority;
            
            // Format due date for input field (YYYY-MM-DD)
            if (task.dueDate) {
                const dueDate = task.dueDate.toDate ? task.dueDate.toDate() : new Date(task.dueDate);
                const formattedDate = dueDate.toISOString().split('T')[0];
                document.getElementById('editTaskDueDate').value = formattedDate;
            } else {
                document.getElementById('editTaskDueDate').value = '';
            }
            
            // Populate worker select dropdown
            populateWorkerSelect('editTaskAssignedTo');
            document.getElementById('editTaskAssignedTo').value = task.assignedTo || '';
            
            // Show the modal
            document.getElementById('editTaskModal').style.display = 'block';
        }

        // Update task
        async function updateTask(taskData) {
            try {
                const taskId = taskData.id;
                delete taskData.id; // Remove id from data to be updated
                
                // Convert due date string to Date object if provided
                if (taskData.dueDate) {
                    taskData.dueDate = new Date(taskData.dueDate);
                }
                
                // Add updated timestamp
                taskData.updatedAt = window.serverTimestamp();
                
                await window.updateDoc(window.doc(window.db, 'tasks', taskId), taskData);
                showNotification('Task updated successfully!');
                closeModal('editTaskModal');
                loadTasks();
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task. Please try again.');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task? This action cannot be undone.')) {
                try {
                    await window.deleteDoc(window.doc(window.db, 'tasks', taskId));
                    showNotification('Task deleted successfully!');
                    loadTasks();
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Error deleting task. Please try again.');
                }
            }
        }

        // Handle edit task form submission
        document.getElementById('editTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const taskData = {
                id: document.getElementById('editTaskId').value,
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDescription').value,
                projectName: document.getElementById('editTaskProject').value,
                assignedTo: document.getElementById('editTaskAssignedTo').value,
                status: document.getElementById('editTaskStatus').value,
                priority: document.getElementById('editTaskPriority').value,
                dueDate: document.getElementById('editTaskDueDate').value
            };
            
            await updateTask(taskData);
        });

        // Load work sessions
        async function loadWorkSessions() {
            try {
                const workSessionsContainer = document.getElementById('workSessionsContainer');
                workSessionsContainer.innerHTML = '<div class="loading">Loading work sessions...</div>';

                const q = window.query(window.collection(window.db, 'workSessions'), window.orderBy('createdAt', 'desc'));
                const querySnapshot = await window.getDocs(q);
                
                allWorkSessions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allWorkSessions.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Populate worker filter
                populateWorkerFilter();
                
                // Set default date filters (last 30 days)
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                document.getElementById('dateFromFilter').value = thirtyDaysAgo.toISOString().split('T')[0];
                document.getElementById('dateToFilter').value = today.toISOString().split('T')[0];

                applyWorkSessionFilters();
                
                // Update today's work time when work sessions are loaded
                updateTodayWorkTime();
                
            } catch (error) {
                console.error('Error loading work sessions:', error);
                document.getElementById('workSessionsContainer').innerHTML = 
                    '<div style="color: #ff4757; text-align: center; padding: 20px;">Error loading work sessions</div>';
            }
        }

        // Populate worker filter dropdown
        function populateWorkerFilter() {
            const workerFilter = document.getElementById('workerFilter');
            workerFilter.innerHTML = '<option value="">All Workers</option>';
            
            const uniqueWorkers = [...new Set(allWorkSessions.map(session => `${session.workerName}|${session.workerId}`))];
            uniqueWorkers.forEach(workerData => {
                const [name, id] = workerData.split('|');
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                workerFilter.appendChild(option);
            });
        }

                 // ===== WORK POLICY SYSTEM =====

         // Work Policy Configuration
         const WORK_POLICY = {
             WORK_START_TIME: 10, // 10 AM
             LATE_THRESHOLD_1: 11, // 11 AM - 0.25 day penalty
             LATE_THRESHOLD_2: 12, // 12 PM - 0.5 day penalty
             STANDARD_HOURS: 8, // 8 hours standard work day
             STANDARD_MONTHLY_DAYS: 22, // 22 working days per month
             OVERTIME_MULTIPLIER: 1.5, // 1.5x for overtime
             LATE_PENALTY_1: 0.25, // Quarter day penalty
             LATE_PENALTY_2: 0.5   // Half day penalty
         };

         // Calculate attendance policy for a work session
         function calculateAttendancePolicy(session) {
             if (!session.loginTime || !session.totalWorkTime) {
                 return {
                     isLate: false,
                     latePenalty: 0,
                     regularHours: 0,
                     overtimeHours: 0,
                     overtimePay: 0,
                     attendanceStatus: 'incomplete'
                 };
             }

             const loginTime = new Date(session.loginTime.toDate());
             const loginHour = loginTime.getHours();
             const loginMinute = loginTime.getMinutes();
             const loginTimeDecimal = loginHour + (loginMinute / 60);

             // Calculate if late and penalty
             let isLate = false;
             let latePenalty = 0;
             let attendanceStatus = 'on-time';

             if (loginTimeDecimal >= WORK_POLICY.LATE_THRESHOLD_2) {
                 isLate = true;
                 latePenalty = WORK_POLICY.LATE_PENALTY_2;
                 attendanceStatus = 'very-late';
             } else if (loginTimeDecimal >= WORK_POLICY.LATE_THRESHOLD_1) {
                 isLate = true;
                 latePenalty = WORK_POLICY.LATE_PENALTY_1;
                 attendanceStatus = 'late';
             }

             // Calculate work hours
             const totalHours = session.totalWorkTime / (1000 * 60 * 60);
             const regularHours = Math.min(totalHours, WORK_POLICY.STANDARD_HOURS);
             const overtimeHours = Math.max(0, totalHours - WORK_POLICY.STANDARD_HOURS);

             // Calculate overtime pay (as multiplier of regular time)
             const overtimePay = overtimeHours * WORK_POLICY.OVERTIME_MULTIPLIER;

             return {
                 isLate,
                 latePenalty,
                 regularHours: Math.round(regularHours * 100) / 100,
                 overtimeHours: Math.round(overtimeHours * 100) / 100,
                 overtimePay: Math.round(overtimePay * 100) / 100,
                 attendanceStatus,
                 loginTime: loginTime,
                 totalHours: Math.round(totalHours * 100) / 100
             };
         }

         // Calculate monthly working day statistics for a worker
         function calculateMonthlyStats(workerSessions, month, year) {
             if (!workerSessions || workerSessions.length === 0) {
                 return {
                     workingDays: 0,
                     overtimeDays: 0,
                     isMonthlyOvertime: false,
                     monthlyOvertimePay: 0
                 };
             }

             // Filter sessions for the specific month and year
             const monthSessions = workerSessions.filter(session => {
                 if (!session.date) return false;
                 const sessionDate = new Date(session.date);
                 return sessionDate.getMonth() === month && sessionDate.getFullYear() === year;
             });

             // Count unique working days
             const uniqueDays = new Set(monthSessions.map(session => session.date));
             const workingDays = uniqueDays.size;
             
             // Calculate overtime days (days over 22)
             const overtimeDays = Math.max(0, workingDays - WORK_POLICY.STANDARD_MONTHLY_DAYS);
             const isMonthlyOvertime = overtimeDays > 0;
             
             // Calculate monthly overtime pay (overtime days * 1.5 multiplier)
             const monthlyOvertimePay = overtimeDays * WORK_POLICY.OVERTIME_MULTIPLIER;

             return {
                 workingDays,
                 overtimeDays,
                 isMonthlyOvertime,
                 monthlyOvertimePay: Math.round(monthlyOvertimePay * 100) / 100
             };
         }

         // Get current month and year
         function getCurrentMonthYear() {
             const now = new Date();
             return {
                 month: now.getMonth(),
                 year: now.getFullYear(),
                 monthName: now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
             };
         }

         // Format attendance status with color
         function formatAttendanceStatus(status) {
             const statusConfig = {
                 'on-time': { icon: '‚úÖ', color: '#28a745', text: 'On Time' },
                 'late': { icon: '‚ö†Ô∏è', color: '#ffc107', text: 'Late (-0.25 day)' },
                 'very-late': { icon: '‚ùå', color: '#dc3545', text: 'Very Late (-0.5 day)' },
                 'incomplete': { icon: '‚è≥', color: '#6c757d', text: 'Incomplete' }
             };
             
             const config = statusConfig[status] || statusConfig['incomplete'];
             return `<span style="color: ${config.color};">${config.icon} ${config.text}</span>`;
         }

         // Apply work session filters
         function applyWorkSessionFilters() {
             const workerFilter = document.getElementById('workerFilter').value;
             const dateFromFilter = document.getElementById('dateFromFilter').value;
             const dateToFilter = document.getElementById('dateToFilter').value;
             const viewType = document.getElementById('viewTypeFilter').value;

             filteredWorkSessions = allWorkSessions.filter(session => {
                 const matchesWorker = !workerFilter || session.workerId === workerFilter;
                 
                 let matchesDate = true;
                 if (dateFromFilter || dateToFilter) {
                     const sessionDate = session.date || (session.loginTime ? session.loginTime.toDate().toISOString().split('T')[0] : null);
                     if (sessionDate) {
                         if (dateFromFilter && sessionDate < dateFromFilter) matchesDate = false;
                         if (dateToFilter && sessionDate > dateToFilter) matchesDate = false;
                     }
                 }

                 return matchesWorker && matchesDate;
             });

             updateWorkSessionStats();
             renderWorkSessions(viewType);
         }

        // Update work session statistics
        function updateWorkSessionStats() {
            let totalWorkTime = 0;
            let totalRegularHours = 0;
            let totalOvertimeHours = 0;
            let totalLatePenalty = 0;
            let onTimeCount = 0;
            let lateCount = 0;
            let totalMonthlyOvertimeDays = 0;

            const currentDate = getCurrentMonthYear();
            const workerSessions = {};
            
            // Group all sessions by worker for monthly calculations
            allWorkSessions.forEach(session => {
                const workerId = session.workerId;
                if (!workerSessions[workerId]) {
                    workerSessions[workerId] = [];
                }
                workerSessions[workerId].push(session);
            });

            filteredWorkSessions.forEach(session => {
                const policy = calculateAttendancePolicy(session);
                const workTime = session.totalWorkTime || 0;
                
                totalWorkTime += workTime;
                totalRegularHours += policy.regularHours;
                totalOvertimeHours += policy.overtimeHours;
                totalLatePenalty += policy.latePenalty;
                
                if (policy.attendanceStatus === 'on-time') {
                    onTimeCount++;
                } else if (policy.isLate) {
                    lateCount++;
                }
            });

            // Calculate monthly overtime days for all workers
            const uniqueWorkers = new Set(filteredWorkSessions.map(s => s.workerId));
            uniqueWorkers.forEach(workerId => {
                const monthlyStats = calculateMonthlyStats(workerSessions[workerId] || [], currentDate.month, currentDate.year);
                totalMonthlyOvertimeDays += monthlyStats.overtimeDays;
            });

            const totalHours = Math.round(totalWorkTime / (1000 * 60 * 60) * 10) / 10;
            const totalSessions = filteredWorkSessions.length;
            const avgSession = totalSessions > 0 ? Math.round((totalWorkTime / totalSessions) / (1000 * 60 * 60) * 10) / 10 : 0;
            const onTimeRate = totalSessions > 0 ? Math.round((onTimeCount / totalSessions) * 100) : 0;

            document.getElementById('totalWorkHours').textContent = `${totalHours}h (${Math.round(totalRegularHours * 10) / 10}h reg + ${Math.round(totalOvertimeHours * 10) / 10}h daily OT)`;
            document.getElementById('totalSessions').textContent = `${totalSessions} (${onTimeCount} on-time, ${lateCount} late)`;
            document.getElementById('activeWorkers').textContent = `${uniqueWorkers.size} workers (${onTimeRate}% on-time)`;
            document.getElementById('avgSessionLength').textContent = `${avgSession}h avg ‚Ä¢ ${totalMonthlyOvertimeDays} monthly OT days`;
        }

        // Render work sessions based on view type
        function renderWorkSessions(viewType) {
            const container = document.getElementById('workSessionsContainer');
            
            if (filteredWorkSessions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #888888; padding: 40px;">
                        <p>No work sessions found for the selected criteria.</p>
                    </div>
                `;
                return;
            }

            let content = '';
            
            if (viewType === 'daily') {
                content = renderDailySummary();
            } else if (viewType === 'sessions') {
                content = renderIndividualSessions();
            } else if (viewType === 'totals') {
                content = renderWorkerTotals();
            }

            container.innerHTML = content;
        }

        // Render daily summary view
        function renderDailySummary() {
            const dailyData = {};
            const currentDate = getCurrentMonthYear();
            const workerSessions = {};
            
            // Group all sessions by worker for monthly calculations
            allWorkSessions.forEach(session => {
                const workerId = session.workerId;
                if (!workerSessions[workerId]) {
                    workerSessions[workerId] = [];
                }
                workerSessions[workerId].push(session);
            });
            
            filteredWorkSessions.forEach(session => {
                const date = session.date || (session.loginTime ? session.loginTime.toDate().toISOString().split('T')[0] : 'Unknown');
                const policy = calculateAttendancePolicy(session);
                
                if (!dailyData[date]) {
                    dailyData[date] = {
                        workers: new Set(),
                        workerIds: new Set(),
                        totalWork: 0,
                        regularHours: 0,
                        overtimeHours: 0,
                        onTimeWorkers: 0,
                        lateWorkers: 0,
                        totalPenalty: 0,
                        sessions: 0,
                        sessionDetails: []
                    };
                }
                
                dailyData[date].workers.add(session.workerName);
                dailyData[date].workerIds.add(session.workerId);
                dailyData[date].totalWork += session.totalWorkTime || 0;
                dailyData[date].regularHours += policy.regularHours;
                dailyData[date].overtimeHours += policy.overtimeHours;
                dailyData[date].totalPenalty += policy.latePenalty;
                dailyData[date].sessions++;
                
                if (policy.isLate) {
                    dailyData[date].lateWorkers++;
                } else if (policy.attendanceStatus === 'on-time') {
                    dailyData[date].onTimeWorkers++;
                }
                
                dailyData[date].sessionDetails.push({
                    workerName: session.workerName,
                    workerId: session.workerId,
                    policy: policy
                });
            });

            return Object.entries(dailyData)
                .sort(([a], [b]) => b.localeCompare(a))
                .map(([date, data]) => {
                    const attendanceRate = data.workers.size > 0 ? ((data.onTimeWorkers / data.workers.size) * 100).toFixed(1) : 0;
                    
                    // Calculate how many workers are at monthly overtime on this day
                    let workersWithMonthlyOT = 0;
                    data.workerIds.forEach(workerId => {
                        const monthlyStats = calculateMonthlyStats(workerSessions[workerId] || [], currentDate.month, currentDate.year);
                        if (monthlyStats.isMonthlyOvertime) {
                            workersWithMonthlyOT++;
                        }
                    });
                    
                    return `
                        <div class="worker-card">
                            <div class="worker-header">
                                <div class="worker-name">üìÖ ${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                <div class="worker-role" style="background: ${attendanceRate >= 90 ? 'rgba(40, 167, 69, 0.2)' : attendanceRate >= 70 ? 'rgba(255, 193, 7, 0.2)' : 'rgba(220, 53, 69, 0.2)'}; color: ${attendanceRate >= 90 ? '#28a745' : attendanceRate >= 70 ? '#ffc107' : '#dc3545'};">${attendanceRate}% On-Time</div>
                            </div>
                            <div class="worker-details">
                                <strong>Total Work Time:</strong> ${formatDuration(data.totalWork)}<br>
                                <strong>Regular Hours:</strong> ${data.regularHours.toFixed(1)}h<br>
                                <strong>Daily Overtime Hours:</strong> ${data.overtimeHours.toFixed(1)}h ${data.overtimeHours > 0 ? '(x1.5 rate)' : ''}<br>
                                <strong>Workers Present:</strong> ${data.workers.size}<br>
                                <strong>On-Time Workers:</strong> <span style="color: #28a745;">${data.onTimeWorkers}</span><br>
                                <strong>Late Workers:</strong> <span style="color: ${data.lateWorkers > 0 ? '#dc3545' : '#28a745'};">${data.lateWorkers}</span><br>
                                ${data.totalPenalty > 0 ? `<strong>Total Penalties:</strong> <span style="color: #dc3545;">-${data.totalPenalty.toFixed(2)} days</span><br>` : ''}
                                <strong>Workers on Monthly OT (>22 days):</strong> <span style="color: ${workersWithMonthlyOT > 0 ? '#ffc107' : '#28a745'};">${workersWithMonthlyOT}</span><br>
                                <strong>Total Sessions:</strong> ${data.sessions}<br>
                                <strong>Workers:</strong> ${Array.from(data.workers).join(', ')}
                            </div>
                            ${data.sessionDetails.length > 0 ? `
                                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <strong>Session Details:</strong><br>
                                    ${data.sessionDetails.map(detail => {
                                        const monthlyStats = calculateMonthlyStats(workerSessions[detail.workerId] || [], currentDate.month, currentDate.year);
                                        return `
                                            <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.03); border-radius: 4px;">
                                                <strong>${detail.workerName}:</strong> ${detail.policy.totalHours}h 
                                                (${detail.policy.regularHours}h regular + ${detail.policy.overtimeHours}h daily OT) 
                                                ${formatAttendanceStatus(detail.policy.attendanceStatus)}
                                                ${detail.policy.latePenalty > 0 ? ` <span style="color: #dc3545;">(-${detail.policy.latePenalty} day)</span>` : ''}
                                                ${monthlyStats.isMonthlyOvertime ? ` <span style="color: #ffc107;">[${monthlyStats.workingDays}/22 days this month]</span>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
        }

        // Render individual sessions view
        function renderIndividualSessions() {
            const currentDate = getCurrentMonthYear();
            const workerSessions = {};
            
            // Group all sessions by worker for monthly calculations
            allWorkSessions.forEach(session => {
                const workerId = session.workerId;
                if (!workerSessions[workerId]) {
                    workerSessions[workerId] = [];
                }
                workerSessions[workerId].push(session);
            });
            
            return filteredWorkSessions.map(session => {
                const policy = calculateAttendancePolicy(session);
                
                // Calculate monthly stats for this worker
                const monthlyStats = calculateMonthlyStats(workerSessions[session.workerId] || [], currentDate.month, currentDate.year);
                
                return `
                    <div class="worker-card">
                        <div class="worker-header">
                            <div class="worker-name">${session.workerName}</div>
                            <div class="worker-role">${session.date || 'No date'} ‚Ä¢ Day ${monthlyStats.workingDays}/22</div>
                        </div>
                        <div class="worker-details">
                            <strong>Login Time:</strong> ${session.loginTime ? new Date(session.loginTime.toDate()).toLocaleString() : 'N/A'}<br>
                            <strong>Logout Time:</strong> ${session.logoutTime ? new Date(session.logoutTime.toDate()).toLocaleString() : 'Active'}<br>
                            <strong>Total Hours:</strong> ${policy.totalHours}h<br>
                            <strong>Regular Hours:</strong> ${policy.regularHours}h<br>
                            <strong>Overtime Hours:</strong> ${policy.overtimeHours}h ${policy.overtimeHours > 0 ? '(x1.5 rate)' : ''}<br>
                            <strong>Attendance Status:</strong> ${formatAttendanceStatus(policy.attendanceStatus)}<br>
                            ${policy.latePenalty > 0 ? `<strong>Late Penalty:</strong> <span style="color: #dc3545;">-${policy.latePenalty} day</span><br>` : ''}
                            <hr style="margin: 10px 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                            <strong>Monthly Context (${currentDate.monthName}):</strong><br>
                            <strong>Working Days This Month:</strong> <span style="color: ${monthlyStats.workingDays > 22 ? '#ffc107' : '#28a745'};">${monthlyStats.workingDays}/22</span><br>
                            ${monthlyStats.isMonthlyOvertime ? `<strong>Monthly Overtime Days:</strong> <span style="color: #ffc107;">${monthlyStats.overtimeDays} days (x1.5 rate)</span><br>` : ''}
                            <strong>Status:</strong> <span class="status-badge ${session.isActive ? 'online' : 'offline'}">${session.isActive ? 'üü¢ Active' : 'üî¥ Completed'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render worker totals view
        function renderWorkerTotals() {
            const workerTotals = {};
            const currentDate = getCurrentMonthYear();
            
            // Group sessions by worker first
            const workerSessions = {};
            filteredWorkSessions.forEach(session => {
                const workerId = session.workerId;
                if (!workerSessions[workerId]) {
                    workerSessions[workerId] = [];
                }
                workerSessions[workerId].push(session);
            });
            
            filteredWorkSessions.forEach(session => {
                const workerId = session.workerId;
                const workerName = session.workerName;
                const policy = calculateAttendancePolicy(session);
                
                if (!workerTotals[workerId]) {
                    workerTotals[workerId] = {
                        name: workerName,
                        totalWork: 0,
                        regularHours: 0,
                        overtimeHours: 0,
                        totalLatePenalty: 0,
                        lateDays: 0,
                        onTimeDays: 0,
                        sessions: 0,
                        days: new Set()
                    };
                }
                
                workerTotals[workerId].totalWork += session.totalWorkTime || 0;
                workerTotals[workerId].regularHours += policy.regularHours;
                workerTotals[workerId].overtimeHours += policy.overtimeHours;
                workerTotals[workerId].totalLatePenalty += policy.latePenalty;
                
                if (policy.isLate) {
                    workerTotals[workerId].lateDays++;
                } else if (policy.attendanceStatus === 'on-time') {
                    workerTotals[workerId].onTimeDays++;
                }
                
                workerTotals[workerId].sessions++;
                if (session.date) {
                    workerTotals[workerId].days.add(session.date);
                }
            });

            return Object.entries(workerTotals)
                .sort(([,a], [,b]) => b.totalWork - a.totalWork)
                .map(([workerId, data]) => {
                    const attendanceRate = data.days.size > 0 ? ((data.onTimeDays / data.days.size) * 100).toFixed(1) : 0;
                    const avgRegularHours = data.days.size > 0 ? (data.regularHours / data.days.size).toFixed(1) : 0;
                    const avgOvertimeHours = data.days.size > 0 ? (data.overtimeHours / data.days.size).toFixed(1) : 0;
                    
                    // Calculate monthly statistics for current month
                    const monthlyStats = calculateMonthlyStats(workerSessions[workerId] || [], currentDate.month, currentDate.year);
                    
                    return `
                        <div class="worker-card">
                            <div class="worker-header">
                                <div class="worker-name">${data.name}</div>
                                <div class="worker-role" style="background: ${attendanceRate >= 90 ? 'rgba(40, 167, 69, 0.2)' : attendanceRate >= 70 ? 'rgba(255, 193, 7, 0.2)' : 'rgba(220, 53, 69, 0.2)'}; color: ${attendanceRate >= 90 ? '#28a745' : attendanceRate >= 70 ? '#ffc107' : '#dc3545'};">${attendanceRate}% On-Time</div>
                            </div>
                            <div class="worker-details">
                                <strong>Total Work Time:</strong> ${formatDuration(data.totalWork)}<br>
                                <strong>Regular Hours:</strong> ${data.regularHours.toFixed(1)}h<br>
                                <strong>Overtime Hours:</strong> ${data.overtimeHours.toFixed(1)}h ${data.overtimeHours > 0 ? '(x1.5 rate)' : ''}<br>
                                <strong>Working Days:</strong> ${data.days.size}<br>
                                <strong>On-Time Days:</strong> <span style="color: #28a745;">${data.onTimeDays}</span><br>
                                <strong>Late Days:</strong> <span style="color: ${data.lateDays > 0 ? '#dc3545' : '#28a745'};">${data.lateDays}</span><br>
                                ${data.totalLatePenalty > 0 ? `<strong>Total Late Penalty:</strong> <span style="color: #dc3545;">-${data.totalLatePenalty.toFixed(2)} days</span><br>` : ''}
                                <hr style="margin: 10px 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                                <strong>${currentDate.monthName} Stats:</strong><br>
                                <strong>Monthly Working Days:</strong> <span style="color: ${monthlyStats.workingDays > 22 ? '#ffc107' : '#28a745'};">${monthlyStats.workingDays}/22</span><br>
                                ${monthlyStats.isMonthlyOvertime ? `<strong>Monthly Overtime Days:</strong> <span style="color: #ffc107;">${monthlyStats.overtimeDays} days (x1.5 rate)</span><br>` : ''}
                                <strong>Avg Daily Regular:</strong> ${avgRegularHours}h<br>
                                <strong>Avg Daily Overtime:</strong> ${avgOvertimeHours}h<br>
                                <strong>Total Sessions:</strong> ${data.sessions}
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Format duration from milliseconds to readable format
        function formatDuration(ms) {
            if (!ms || ms < 0) return '0h 0m';
            
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            
            return `${hours}h ${minutes}m`;
        }

        // Refresh work sessions
        function refreshWorkSessions() {
            loadWorkSessions();
            showNotification('Work sessions refreshed!');
        }

        // Export work time data
        function exportWorkTimeData() {
            if (filteredWorkSessions.length === 0) {
                alert('No data to export. Please adjust your filters.');
                return;
            }

            const currentDate = getCurrentMonthYear();
            const workerSessions = {};
            
            // Group all sessions by worker for monthly calculations
            allWorkSessions.forEach(session => {
                const workerId = session.workerId;
                if (!workerSessions[workerId]) {
                    workerSessions[workerId] = [];
                }
                workerSessions[workerId].push(session);
            });

            const csvData = [];
            csvData.push([
                'Worker Name', 
                'Date', 
                'Login Time', 
                'Logout Time', 
                'Total Hours', 
                'Regular Hours', 
                'Daily Overtime Hours',
                'Attendance Status',
                'Late Penalty (days)',
                'Daily Overtime Pay (multiplier)',
                'Monthly Working Days',
                'Monthly Overtime Days',
                'Monthly Overtime Pay (multiplier)'
            ]);

            filteredWorkSessions.forEach(session => {
                const policy = calculateAttendancePolicy(session);
                const monthlyStats = calculateMonthlyStats(workerSessions[session.workerId] || [], currentDate.month, currentDate.year);
                
                csvData.push([
                    session.workerName || 'Unknown',
                    session.date || 'Unknown',
                    session.loginTime ? new Date(session.loginTime.toDate()).toLocaleString() : 'N/A',
                    session.logoutTime ? new Date(session.logoutTime.toDate()).toLocaleString() : 'Active',
                    policy.totalHours,
                    policy.regularHours,
                    policy.overtimeHours,
                    policy.attendanceStatus,
                    policy.latePenalty,
                    policy.overtimePay,
                    monthlyStats.workingDays,
                    monthlyStats.overtimeDays,
                    monthlyStats.monthlyOvertimePay
                ]);
            });

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `work_time_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showNotification('Work time data exported successfully!');
        }

        // ===== HR DASHBOARD FUNCTIONS =====

        let hrData = {
            workers: [],
            workSessions: [],
            attendanceRecords: [],
            alerts: []
        };

        // Load HR Dashboard
        async function loadHRDashboard() {
            try {
                const hrContainer = document.getElementById('hrContainer');
                hrContainer.innerHTML = '<div class="loading">Loading HR data...</div>';

                // Load all necessary data
                await Promise.all([
                    loadHRWorkers(),
                    loadHRWorkSessions(), 
                    generateHRAlerts()
                ]);

                updateHRStats();
                applyHRFilters();

            } catch (error) {
                console.error('Error loading HR dashboard:', error);
                document.getElementById('hrContainer').innerHTML = 
                    '<div style="color: #ff4757; text-align: center; padding: 20px;">Error loading HR data</div>';
            }
        }

        // Load HR Workers with enhanced data
        async function loadHRWorkers() {
            try {
                const q = window.query(window.collection(window.db, 'workers'));
                const querySnapshot = await window.getDocs(q);
                
                hrData.workers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    hrData.workers.push({
                        id: doc.id,
                        ...data,
                        // Enhanced HR fields with defaults
                        department: data.department || getDepartmentFromRole(data.role),
                        employmentType: data.employmentType || 'full-time',
                        startDate: data.startDate || data.createdAt,
                        hourlyRate: data.hourlyRate || 0,
                        expectedHours: data.expectedHours || 8,
                        emergencyContact: data.emergencyContact || null,
                        skills: data.skills || [],
                        performanceNotes: data.performanceNotes || []
                    });
                });

            } catch (error) {
                console.error('Error loading HR workers:', error);
                hrData.workers = [];
            }
        }

        // Load HR Work Sessions
        async function loadHRWorkSessions() {
            try {
                const q = window.query(window.collection(window.db, 'workSessions'), window.orderBy('createdAt', 'desc'));
                const querySnapshot = await window.getDocs(q);
                
                hrData.workSessions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    hrData.workSessions.push({
                        id: doc.id,
                        ...data
                    });
                });

            } catch (error) {
                console.error('Error loading HR work sessions:', error);
                hrData.workSessions = [];
            }
        }

        // Generate HR Alerts
        async function generateHRAlerts() {
            hrData.alerts = [];
            const today = new Date().toISOString().split('T')[0];
            
            // Attendance alerts
            const expectedWorkers = hrData.workers.filter(w => w.status === 'approved').length;
            const todaysSessions = hrData.workSessions.filter(s => s.date === today);
            const presentWorkers = new Set(todaysSessions.map(s => s.workerId)).size;
            const absentWorkers = expectedWorkers - presentWorkers;

            if (absentWorkers > 0) {
                hrData.alerts.push({
                    type: 'warning',
                    title: 'Workers Absent Today',
                    message: `${absentWorkers} workers have not logged in today`,
                    count: absentWorkers
                });
            }

            // Overtime alerts
            const overtimeSessions = todaysSessions.filter(s => {
                const workHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                return workHours > 8;
            });

            if (overtimeSessions.length > 0) {
                hrData.alerts.push({
                    type: 'info',
                    title: 'Overtime Workers',
                    message: `${overtimeSessions.length} workers are working overtime today`,
                    count: overtimeSessions.length
                });
            }

            // Late arrival alerts
            const lateWorkers = todaysSessions.filter(s => {
                if (!s.loginTime) return false;
                const loginHour = new Date(s.loginTime.toDate()).getHours();
                return loginHour > 9; // Assuming 9 AM is standard start time
            });

            if (lateWorkers.length > 0) {
                hrData.alerts.push({
                    type: 'warning',
                    title: 'Late Arrivals',
                    message: `${lateWorkers.length} workers arrived late today`,
                    count: lateWorkers.length
                });
            }

            // Long session alerts (>10 hours)
            const longSessions = todaysSessions.filter(s => {
                const workHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                return workHours > 10;
            });

            if (longSessions.length > 0) {
                hrData.alerts.push({
                    type: 'danger',
                    title: 'Extended Work Sessions',
                    message: `${longSessions.length} workers have sessions over 10 hours`,
                    count: longSessions.length
                });
            }

            renderHRAlerts();
        }

        // Render HR Alerts
        function renderHRAlerts() {
            const alertsContainer = document.getElementById('hrAlerts');
            
            if (hrData.alerts.length === 0) {
                alertsContainer.innerHTML = '<div style="color: #28a745;">‚úÖ No alerts - All systems normal</div>';
                return;
            }

            alertsContainer.innerHTML = hrData.alerts.map(alert => `
                <div class="alert alert-${alert.type}" style="padding: 10px; margin: 5px 0; border-radius: 5px; background: rgba(${getAlertColor(alert.type)}, 0.1); border: 1px solid rgba(${getAlertColor(alert.type)}, 0.3); color: rgb(${getAlertColor(alert.type)});">
                    <strong>${alert.title}:</strong> ${alert.message}
                </div>
            `).join('');
        }

        // Get alert color
        function getAlertColor(type) {
            const colors = {
                'danger': '220, 53, 69',
                'warning': '255, 193, 7', 
                'info': '0, 123, 255',
                'success': '40, 167, 69'
            };
            return colors[type] || colors.info;
        }

        // Update HR Statistics
        function updateHRStats() {
            const today = new Date().toISOString().split('T')[0];
            const todaysSessions = hrData.workSessions.filter(s => s.date === today);
            
            // Present today
            const presentToday = new Set(todaysSessions.map(s => s.workerId)).size;
            document.getElementById('presentToday').textContent = presentToday;

            // Absent today
            const expectedWorkers = hrData.workers.filter(w => w.status === 'approved').length;
            const absentToday = expectedWorkers - presentToday;
            document.getElementById('absentToday').textContent = absentToday;

            // Late today
            const lateToday = todaysSessions.filter(s => {
                if (!s.loginTime) return false;
                const loginHour = new Date(s.loginTime.toDate()).getHours();
                return loginHour > 9;
            }).length;
            document.getElementById('lateToday').textContent = lateToday;

            // Overtime today
            const overtimeToday = todaysSessions.filter(s => {
                const workHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                return workHours > 8;
            }).length;
            document.getElementById('overtimeToday').textContent = overtimeToday;

            // Attendance rate
            const attendanceRate = expectedWorkers > 0 ? Math.round((presentToday / expectedWorkers) * 100) : 0;
            document.getElementById('avgAttendanceRate').textContent = `${attendanceRate}%`;

            // Total payroll hours
            const totalPayrollHours = todaysSessions.reduce((sum, session) => {
                return sum + ((session.totalWorkTime || 0) / (1000 * 60 * 60));
            }, 0);
            document.getElementById('totalPayrollHours').textContent = `${Math.round(totalPayrollHours * 10) / 10}h`;
        }

        // Apply HR Filters
        function applyHRFilters() {
            const department = document.getElementById('departmentFilter').value;
            const employmentType = document.getElementById('employmentFilter').value;
            const dateRange = document.getElementById('hrDateRange').value;
            const reportType = document.getElementById('hrReportType').value;

            let filteredData = hrData.workers.filter(worker => {
                const matchesDepartment = !department || worker.department === department;
                const matchesEmployment = !employmentType || worker.employmentType === employmentType;
                return matchesDepartment && matchesEmployment;
            });

            renderHRReport(filteredData, reportType, dateRange);
        }

        // Render HR Report
        function renderHRReport(workers, reportType, dateRange) {
            const container = document.getElementById('hrContainer');
            
            switch(reportType) {
                case 'attendance':
                    container.innerHTML = renderAttendanceReport(workers, dateRange);
                    break;
                case 'productivity':
                    container.innerHTML = renderProductivityReport(workers, dateRange);
                    break;
                case 'payroll':
                    container.innerHTML = renderPayrollReport(workers, dateRange);
                    break;
                case 'compliance':
                    container.innerHTML = renderComplianceReport(workers, dateRange);
                    break;
                case 'penalties':
                    loadAndRenderPenaltiesReport(workers, dateRange);
                    break;
                default:
                    container.innerHTML = renderAttendanceReport(workers, dateRange);
            }
        }

        // Render Attendance Report
        function renderAttendanceReport(workers, dateRange) {
            const dateFilter = getDateRange(dateRange);
            
            return workers.map(worker => {
                const workerSessions = hrData.workSessions.filter(s => 
                    s.workerId === worker.id && 
                    new Date(s.date) >= dateFilter.start && 
                    new Date(s.date) <= dateFilter.end
                );

                const workDays = workerSessions.length;
                const totalHours = workerSessions.reduce((sum, s) => sum + ((s.totalWorkTime || 0) / (1000 * 60 * 60)), 0);
                const avgDailyHours = workDays > 0 ? totalHours / workDays : 0;
                const attendanceRate = getExpectedWorkDays(dateRange) > 0 ? (workDays / getExpectedWorkDays(dateRange)) * 100 : 0;

                return `
                    <div class="worker-card" onclick="openWorkerDashboardAsync('${worker.id}')" style="cursor: pointer;">
                        <div class="worker-header">
                            <div class="worker-name">${worker.firstName} ${worker.lastName}</div>
                            <div class="worker-role" style="background: ${attendanceRate >= 90 ? 'rgba(40, 167, 69, 0.2)' : attendanceRate >= 70 ? 'rgba(255, 193, 7, 0.2)' : 'rgba(220, 53, 69, 0.2)'}; color: ${attendanceRate >= 90 ? '#28a745' : attendanceRate >= 70 ? '#ffc107' : '#dc3545'};">${Math.round(attendanceRate)}% Attendance</div>
                        </div>
                        <div class="worker-details">
                            <strong>Department:</strong> ${formatDepartment(worker.department)}<br>
                            <strong>Employment Type:</strong> ${formatEmploymentType(worker.employmentType)}<br>
                            <strong>Work Days:</strong> ${workDays} / ${getExpectedWorkDays(dateRange)}<br>
                            <strong>Total Hours:</strong> ${Math.round(totalHours * 10) / 10}h<br>
                            <strong>Avg Daily Hours:</strong> ${Math.round(avgDailyHours * 10) / 10}h<br>
                            <strong>Expected Hours:</strong> ${worker.expectedHours}h/day<br>
                            <strong>Status:</strong> <span class="status-badge ${worker.isOnline ? 'online' : 'offline'}">${worker.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}</span>
                        </div>
                        ${workerSessions.length > 0 ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <strong>Recent Sessions:</strong><br>
                                ${workerSessions.slice(-5).map(session => `
                                    ${session.date}: ${Math.round((session.totalWorkTime || 0) / (1000 * 60 * 60) * 10) / 10}h
                                `).join('<br>')}
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px; text-align: center; color: #ef414b; font-size: 0.9rem; font-weight: 600;">
                            üëÜ Click to view detailed dashboard
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Productivity Report
        function renderProductivityReport(workers, dateRange) {
            const dateFilter = getDateRange(dateRange);
            
            return workers.map(worker => {
                const workerSessions = hrData.workSessions.filter(s => 
                    s.workerId === worker.id && 
                    new Date(s.date) >= dateFilter.start && 
                    new Date(s.date) <= dateFilter.end
                );

                const totalHours = workerSessions.reduce((sum, s) => sum + ((s.totalWorkTime || 0) / (1000 * 60 * 60)), 0);
                const avgSessionLength = workerSessions.length > 0 ? totalHours / workerSessions.length : 0;
                const productivity = calculateProductivityScore(worker, workerSessions);

                return `
                    <div class="worker-card">
                        <div class="worker-header">
                            <div class="worker-name">${worker.firstName} ${worker.lastName}</div>
                            <div class="worker-role" style="background: ${productivity >= 80 ? 'rgba(40, 167, 69, 0.2)' : productivity >= 60 ? 'rgba(255, 193, 7, 0.2)' : 'rgba(220, 53, 69, 0.2)'}; color: ${productivity >= 80 ? '#28a745' : productivity >= 60 ? '#ffc107' : '#dc3545'};">${productivity}% Productive</div>
                        </div>
                        <div class="worker-details">
                            <strong>Total Work Hours:</strong> ${Math.round(totalHours * 10) / 10}h<br>
                            <strong>Sessions:</strong> ${workerSessions.length}<br>
                            <strong>Avg Session:</strong> ${Math.round(avgSessionLength * 10) / 10}h<br>
                            <strong>Tasks Completed:</strong> ${worker.completedTasks || 0}<br>
                            <strong>Total Tasks:</strong> ${worker.totalTasks || 0}<br>
                            <strong>Completion Rate:</strong> ${worker.totalTasks > 0 ? Math.round((worker.completedTasks / worker.totalTasks) * 100) : 0}%<br>
                            <strong>Performance Rating:</strong> ${getPerformanceRating(productivity)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Payroll Report
        function renderPayrollReport(workers, dateRange) {
            const dateFilter = getDateRange(dateRange);
            
            return workers.map(worker => {
                const workerSessions = hrData.workSessions.filter(s => 
                    s.workerId === worker.id && 
                    new Date(s.date) >= dateFilter.start && 
                    new Date(s.date) <= dateFilter.end
                );

                const regularHours = workerSessions.reduce((sum, s) => {
                    const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                    return sum + Math.min(sessionHours, 8);
                }, 0);

                const overtimeHours = workerSessions.reduce((sum, s) => {
                    const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                    return sum + Math.max(0, sessionHours - 8);
                }, 0);

                const hourlyRate = worker.hourlyRate || 25; // Default rate
                const regularPay = regularHours * hourlyRate;
                const overtimePay = overtimeHours * hourlyRate * 1.5;
                const totalPay = regularPay + overtimePay;

                return `
                    <div class="worker-card">
                        <div class="worker-header">
                            <div class="worker-name">${worker.firstName} ${worker.lastName}</div>
                            <div class="worker-role">$${Math.round(totalPay)} Total</div>
                        </div>
                        <div class="worker-details">
                            <strong>Regular Hours:</strong> ${Math.round(regularHours * 10) / 10}h<br>
                            <strong>Overtime Hours:</strong> ${Math.round(overtimeHours * 10) / 10}h<br>
                            <strong>Hourly Rate:</strong> $${hourlyRate}<br>
                            <strong>Regular Pay:</strong> $${Math.round(regularPay)}<br>
                            <strong>Overtime Pay:</strong> $${Math.round(overtimePay)}<br>
                            <strong>Total Pay:</strong> <span style="color: #28a745; font-weight: bold;">$${Math.round(totalPay)}</span><br>
                            <strong>Employment Type:</strong> ${formatEmploymentType(worker.employmentType)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render Compliance Report
        function renderComplianceReport(workers, dateRange) {
            const dateFilter = getDateRange(dateRange);
            
            return workers.map(worker => {
                const workerSessions = hrData.workSessions.filter(s => 
                    s.workerId === worker.id && 
                    new Date(s.date) >= dateFilter.start && 
                    new Date(s.date) <= dateFilter.end
                );

                const violations = [];
                
                // Check for long sessions (>12 hours)
                const longSessions = workerSessions.filter(s => (s.totalWorkTime || 0) / (1000 * 60 * 60) > 12);
                if (longSessions.length > 0) {
                    violations.push(`${longSessions.length} sessions over 12 hours`);
                }

                // Check for excessive overtime
                const totalOvertimeHours = workerSessions.reduce((sum, s) => {
                    const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                    return sum + Math.max(0, sessionHours - 8);
                }, 0);

                if (totalOvertimeHours > 20) {
                    violations.push(`Excessive overtime: ${Math.round(totalOvertimeHours)}h`);
                }

                // Check for missing required info
                const missingInfo = [];
                if (!worker.emergencyContact) missingInfo.push('Emergency Contact');
                if (!worker.startDate) missingInfo.push('Start Date');
                if (!worker.hourlyRate) missingInfo.push('Hourly Rate');

                if (missingInfo.length > 0) {
                    violations.push(`Missing: ${missingInfo.join(', ')}`);
                }

                const compliant = violations.length === 0;

                return `
                    <div class="worker-card">
                        <div class="worker-header">
                            <div class="worker-name">${worker.firstName} ${worker.lastName}</div>
                            <div class="worker-role" style="background: ${compliant ? 'rgba(40, 167, 69, 0.2)' : 'rgba(220, 53, 69, 0.2)'}; color: ${compliant ? '#28a745' : '#dc3545'};">${compliant ? '‚úÖ Compliant' : '‚ö†Ô∏è Issues'}</div>
                        </div>
                        <div class="worker-details">
                            <strong>Total Sessions:</strong> ${workerSessions.length}<br>
                            <strong>Overtime Hours:</strong> ${Math.round(totalOvertimeHours * 10) / 10}h<br>
                            <strong>Long Sessions:</strong> ${longSessions.length}<br>
                            <strong>Account Status:</strong> ${worker.status}<br>
                            <strong>Last Login:</strong> ${worker.lastLogin ? new Date(worker.lastLogin.toDate()).toLocaleDateString() : 'Never'}<br>
                            ${violations.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 5px; border: 1px solid rgba(220, 53, 69, 0.3);">
                                    <strong style="color: #dc3545;">Compliance Issues:</strong><br>
                                    ${violations.map(v => `‚Ä¢ ${v}`).join('<br>')}
                                </div>
                            ` : '<div style="color: #28a745; font-weight: bold;">‚úÖ All compliance checks passed</div>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load and Render Penalties Report
        async function loadAndRenderPenaltiesReport(workers, dateRange) {
            try {
                const container = document.getElementById('hrContainer');
                container.innerHTML = '<div class="loading">Loading penalties data...</div>';

                // Load penalties from Firebase
                const penaltiesQuery = window.query(
                    window.collection(window.db, 'penalties'),
                    window.orderBy('appliedAt', 'desc')
                );
                const penaltiesSnapshot = await window.getDocs(penaltiesQuery);
                
                const penalties = [];
                penaltiesSnapshot.forEach((doc) => {
                    penalties.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                container.innerHTML = renderPenaltiesReport(workers, penalties, dateRange);

            } catch (error) {
                console.error('Error loading penalties:', error);
                const container = document.getElementById('hrContainer');
                container.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px;">Error loading penalties data</div>';
            }
        }

        // Render Penalties Report
        function renderPenaltiesReport(workers, penalties, dateRange) {
            const dateFilter = getDateRange(dateRange);
            
            // Filter penalties by date range
            const filteredPenalties = penalties.filter(penalty => {
                if (!penalty.appliedAt) return false;
                const penaltyDate = new Date(penalty.appliedAt.toDate());
                return penaltyDate >= dateFilter.start && penaltyDate <= dateFilter.end;
            });

            // Group penalties by worker
            const penaltiesByWorker = {};
            filteredPenalties.forEach(penalty => {
                if (!penaltiesByWorker[penalty.workerId]) {
                    penaltiesByWorker[penalty.workerId] = [];
                }
                penaltiesByWorker[penalty.workerId].push(penalty);
            });

            // Calculate summary statistics
            const totalPenalties = filteredPenalties.filter(p => p.type === 'deduction').length;
            const totalBonuses = filteredPenalties.filter(p => p.type === 'bonus').length;
            const totalDeductionDays = filteredPenalties.filter(p => p.type === 'deduction').reduce((sum, p) => sum + p.amount, 0);
            const totalBonusDays = filteredPenalties.filter(p => p.type === 'bonus').reduce((sum, p) => sum + p.amount, 0);

            let content = `
                <div style="margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <h3 style="color: #fff; margin: 0 0 15px 0;">üìä Penalties & Bonuses Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">
                            <div style="color: #dc3545; font-size: 1.5rem; font-weight: bold;">${totalPenalties}</div>
                            <div style="color: #fff; font-size: 0.9rem;">Total Penalties</div>
                        </div>
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.3);">
                            <div style="color: #28a745; font-size: 1.5rem; font-weight: bold;">${totalBonuses}</div>
                            <div style="color: #fff; font-size: 0.9rem;">Total Bonuses</div>
                        </div>
                        <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">
                            <div style="color: #dc3545; font-size: 1.5rem; font-weight: bold;">${totalDeductionDays.toFixed(1)}</div>
                            <div style="color: #fff; font-size: 0.9rem;">Days Deducted</div>
                        </div>
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(40, 167, 69, 0.3);">
                            <div style="color: #28a745; font-size: 1.5rem; font-weight: bold;">${totalBonusDays.toFixed(1)}</div>
                            <div style="color: #fff; font-size: 0.9rem;">Bonus Days Added</div>
                        </div>
                    </div>
                </div>
            `;

            if (filteredPenalties.length === 0) {
                content += `
                    <div style="text-align: center; color: #888; padding: 40px;">
                        <p>No penalties or bonuses applied in the selected date range.</p>
                    </div>
                `;
                return content;
            }

            // Group penalties by date for chronological display
            const penaltiesByDate = {};
            filteredPenalties.forEach(penalty => {
                const date = new Date(penalty.appliedAt.toDate()).toDateString();
                if (!penaltiesByDate[date]) {
                    penaltiesByDate[date] = [];
                }
                penaltiesByDate[date].push(penalty);
            });

            // Sort dates in descending order
            const sortedDates = Object.keys(penaltiesByDate).sort((a, b) => new Date(b) - new Date(a));

            content += sortedDates.map(date => `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #ef414b; margin: 0 0 15px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        üìÖ ${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </h4>
                    ${penaltiesByDate[date].map(penalty => `
                        <div class="worker-card" style="margin-bottom: 10px;">
                            <div class="worker-header">
                                <div class="worker-name">${penalty.workerName}</div>
                                <div class="worker-role" style="background: ${penalty.type === 'deduction' ? 'rgba(220, 53, 69, 0.2)' : 'rgba(40, 167, 69, 0.2)'}; color: ${penalty.type === 'deduction' ? '#dc3545' : '#28a745'};">
                                    ${penalty.type === 'deduction' ? 'üí∏' : 'üí∞'} ${penalty.amount} day${penalty.amount !== 1 ? 's' : ''} ${penalty.type === 'deduction' ? 'Penalty' : 'Bonus'}
                                </div>
                            </div>
                            <div class="worker-details">
                                <strong>Type:</strong> ${penalty.type === 'deduction' ? 'üí∏ Penalty' : 'üí∞ Bonus'}<br>
                                <strong>Amount:</strong> ${penalty.amount} day${penalty.amount !== 1 ? 's' : ''}<br>
                                <strong>Reason:</strong> ${penalty.reason}<br>
                                <strong>Applied By:</strong> ${penalty.appliedBy}<br>
                                <strong>Applied At:</strong> ${new Date(penalty.appliedAt.toDate()).toLocaleString()}<br>
                                <strong>Category:</strong> <span style="color: ${penalty.category === 'manual' ? '#ffc107' : '#007bff'};">${penalty.category === 'manual' ? 'üë®‚Äçüíº Manual' : 'ü§ñ Automatic'}</span><br>
                                ${penalty.alertId ? '<strong>Via Alert:</strong> Yes<br>' : ''}
                                ${penalty.description ? `<strong>Description:</strong> ${penalty.description}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');

            return content;
        }

        // Helper Functions
        function getDepartmentFromRole(role) {
            const roleToDept = {
                'developer': 'development',
                'frontend-developer': 'development',
                'backend-developer': 'development',
                'designer': 'design',
                'marketing-specialist': 'marketing',
                'project-manager': 'management'
            };
            return roleToDept[role] || 'general';
        }

        function getDateRange(range) {
            const today = new Date();
            const start = new Date();
            
            switch(range) {
                case 'today':
                    return { start: today, end: today };
                case 'week':
                    start.setDate(today.getDate() - 7);
                    return { start, end: today };
                case 'month':
                    start.setMonth(today.getMonth() - 1);
                    return { start, end: today };
                case 'quarter':
                    start.setMonth(today.getMonth() - 3);
                    return { start, end: today };
                case 'year':
                    start.setFullYear(today.getFullYear() - 1);
                    return { start, end: today };
                default:
                    return { start: today, end: today };
            }
        }

        function getExpectedWorkDays(range) {
            const days = { today: 1, week: 5, month: 22, quarter: 66, year: 252 };
            return days[range] || 1;
        }

        function calculateProductivityScore(worker, sessions) {
            if (sessions.length === 0) return 0;
            
            const avgHours = sessions.reduce((sum, s) => sum + ((s.totalWorkTime || 0) / (1000 * 60 * 60)), 0) / sessions.length;
            const expectedHours = worker.expectedHours || 8;
            const taskCompletion = worker.totalTasks > 0 ? (worker.completedTasks / worker.totalTasks) * 100 : 50;
            
            return Math.min(100, Math.round(((avgHours / expectedHours) * 70) + (taskCompletion * 0.3)));
        }

        function getPerformanceRating(score) {
            if (score >= 90) return '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent';
            if (score >= 80) return '‚≠ê‚≠ê‚≠ê‚≠ê Good';
            if (score >= 70) return '‚≠ê‚≠ê‚≠ê Average';
            if (score >= 60) return '‚≠ê‚≠ê Below Average';
            return '‚≠ê Needs Improvement';
        }

        function formatDepartment(dept) {
            return dept.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatEmploymentType(type) {
            return type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('-');
        }

        // Export Functions
        function generatePayrollReport() {
            const workers = hrData.workers.filter(w => w.status === 'approved');
            const dateRange = document.getElementById('hrDateRange').value;
            const dateFilter = getDateRange(dateRange);
            
            const csvData = [];
            csvData.push(['Employee Name', 'Employee ID', 'Department', 'Regular Hours', 'Overtime Hours', 'Hourly Rate', 'Regular Pay', 'Overtime Pay', 'Total Pay']);

            workers.forEach(worker => {
                const workerSessions = hrData.workSessions.filter(s => 
                    s.workerId === worker.id && 
                    new Date(s.date) >= dateFilter.start && 
                    new Date(s.date) <= dateFilter.end
                );

                const regularHours = workerSessions.reduce((sum, s) => {
                    const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                    return sum + Math.min(sessionHours, 8);
                }, 0);

                const overtimeHours = workerSessions.reduce((sum, s) => {
                    const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                    return sum + Math.max(0, sessionHours - 8);
                }, 0);

                const hourlyRate = worker.hourlyRate || 25;
                const regularPay = regularHours * hourlyRate;
                const overtimePay = overtimeHours * hourlyRate * 1.5;
                const totalPay = regularPay + overtimePay;

                csvData.push([
                    `${worker.firstName} ${worker.lastName}`,
                    worker.id,
                    formatDepartment(worker.department),
                    regularHours.toFixed(2),
                    overtimeHours.toFixed(2),
                    hourlyRate,
                    regularPay.toFixed(2),
                    overtimePay.toFixed(2),
                    totalPay.toFixed(2)
                ]);
            });

            downloadCSV(csvData, `payroll_report_${dateRange}_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('Payroll report exported successfully!');
        }

        function exportAttendanceData() {
            const workers = hrData.workers.filter(w => w.status === 'approved');
            const dateRange = document.getElementById('hrDateRange').value;
            const dateFilter = getDateRange(dateRange);
            
            const csvData = [];
            csvData.push(['Employee Name', 'Employee ID', 'Department', 'Work Days', 'Total Hours', 'Avg Daily Hours', 'Attendance Rate', 'Late Days']);

            workers.forEach(worker => {
                const workerSessions = hrData.workSessions.filter(s => 
                    s.workerId === worker.id && 
                    new Date(s.date) >= dateFilter.start && 
                    new Date(s.date) <= dateFilter.end
                );

                const workDays = workerSessions.length;
                const totalHours = workerSessions.reduce((sum, s) => sum + ((s.totalWorkTime || 0) / (1000 * 60 * 60)), 0);
                const avgDailyHours = workDays > 0 ? totalHours / workDays : 0;
                const attendanceRate = getExpectedWorkDays(dateRange) > 0 ? (workDays / getExpectedWorkDays(dateRange)) * 100 : 0;
                const lateDays = workerSessions.filter(s => {
                    if (!s.loginTime) return false;
                    const loginHour = new Date(s.loginTime.toDate()).getHours();
                    return loginHour > 9;
                }).length;

                csvData.push([
                    `${worker.firstName} ${worker.lastName}`,
                    worker.id,
                    formatDepartment(worker.department),
                    workDays,
                    totalHours.toFixed(2),
                    avgDailyHours.toFixed(2),
                    `${attendanceRate.toFixed(1)}%`,
                    lateDays
                ]);
            });

            downloadCSV(csvData, `attendance_report_${dateRange}_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('Attendance report exported successfully!');
        }

        function downloadCSV(data, filename) {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function refreshHRData() {
            loadHRDashboard();
            showNotification('HR data refreshed!');
        }

        // ===== SEARCH FUNCTIONALITY =====

        let originalHRData = null;

        function searchWorkers() {
            const searchTerm = document.getElementById('workerSearchInput').value.toLowerCase().trim();
            
            if (!originalHRData) {
                originalHRData = [...hrData.workers];
            }

            if (!searchTerm) {
                hrData.workers = [...originalHRData];
            } else {
                hrData.workers = originalHRData.filter(worker => {
                    return (
                        worker.firstName.toLowerCase().includes(searchTerm) ||
                        worker.lastName.toLowerCase().includes(searchTerm) ||
                        worker.email.toLowerCase().includes(searchTerm) ||
                        worker.department.toLowerCase().includes(searchTerm) ||
                        worker.role.toLowerCase().includes(searchTerm) ||
                        worker.employmentType.toLowerCase().includes(searchTerm) ||
                        (worker.skills && worker.skills.some(skill => skill.toLowerCase().includes(searchTerm)))
                    );
                });
            }

            applyHRFilters();
        }

        function clearSearch() {
            document.getElementById('workerSearchInput').value = '';
            if (originalHRData) {
                hrData.workers = [...originalHRData];
                applyHRFilters();
            }
        }

        // ===== ALERT SYSTEM =====

        function openSendAlertModal() {
            // Populate worker dropdown
            const workerSelect = document.getElementById('alertWorker');
            workerSelect.innerHTML = '<option value="">Select worker</option>';
            
            hrData.workers.filter(w => w.status === 'approved').forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.firstName} ${worker.lastName}`;
                workerSelect.appendChild(option);
            });

            document.getElementById('sendAlertModal').style.display = 'block';
        }

        function toggleRecipientFields() {
            const recipient = document.getElementById('alertRecipient').value;
            const departmentGroup = document.getElementById('departmentSelectGroup');
            const workerGroup = document.getElementById('workerSelectGroup');

            departmentGroup.style.display = recipient === 'department' ? 'block' : 'none';
            workerGroup.style.display = recipient === 'individual' ? 'block' : 'none';
        }

        async function sendAlert() {
            try {
                const formData = {
                    type: document.getElementById('alertType').value,
                    title: document.getElementById('alertTitle').value,
                    message: document.getElementById('alertMessage').value,
                    recipient: document.getElementById('alertRecipient').value,
                    department: document.getElementById('alertDepartment').value,
                    workerId: document.getElementById('alertWorker').value,
                    priority: document.getElementById('alertPriority').value,
                    penalty: document.getElementById('alertPenalty').value,
                    penaltyReason: document.getElementById('alertPenaltyReason').value
                };

                // Validation
                if (!formData.type || !formData.title || !formData.message || !formData.recipient || !formData.priority) {
                    showError('Please fill in all required fields.');
                    return;
                }

                // Validate penalty reason if penalty is selected
                if (formData.penalty && !formData.penaltyReason.trim()) {
                    showError('Please provide a reason for the penalty/bonus.');
                    return;
                }

                // Determine recipients
                let recipients = [];
                const today = new Date().toISOString().split('T')[0];
                const todaysSessions = hrData.workSessions.filter(s => s.date === today);

                switch(formData.recipient) {
                    case 'all':
                        recipients = hrData.workers.filter(w => w.status === 'approved').map(w => w.id);
                        break;
                    case 'department':
                        if (!formData.department) {
                            showError('Please select a department.');
                            return;
                        }
                        recipients = hrData.workers.filter(w => w.status === 'approved' && w.department === formData.department).map(w => w.id);
                        break;
                    case 'individual':
                        if (!formData.workerId) {
                            showError('Please select a worker.');
                            return;
                        }
                        recipients = [formData.workerId];
                        break;
                    case 'absent':
                        const presentWorkers = new Set(todaysSessions.map(s => s.workerId));
                        recipients = hrData.workers.filter(w => w.status === 'approved' && !presentWorkers.has(w.id)).map(w => w.id);
                        break;
                    case 'late':
                        const lateWorkers = todaysSessions.filter(s => {
                            if (!s.loginTime) return false;
                            const loginHour = new Date(s.loginTime.toDate()).getHours();
                            return loginHour > 9;
                        });
                        recipients = lateWorkers.map(s => s.workerId);
                        break;
                    case 'overtime':
                        const overtimeWorkers = todaysSessions.filter(s => {
                            const workHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                            return workHours > 8;
                        });
                        recipients = overtimeWorkers.map(s => s.workerId);
                        break;
                }

                if (recipients.length === 0) {
                    showError('No recipients found for the selected criteria.');
                    return;
                }

                // Apply penalties if specified
                if (formData.penalty) {
                    const penaltyValue = parseFloat(formData.penalty);
                    const penaltyType = penaltyValue > 0 ? 'deduction' : 'bonus';
                    const absValue = Math.abs(penaltyValue);
                    
                    // Apply penalty to each recipient
                    for (const recipientId of recipients) {
                        const worker = hrData.workers.find(w => w.id === recipientId);
                        if (worker) {
                            // Create penalty record
                            const penaltyRecord = {
                                workerId: recipientId,
                                workerName: `${worker.firstName} ${worker.lastName}`,
                                workerEmail: worker.email,
                                type: penaltyType,
                                amount: absValue,
                                reason: formData.penaltyReason,
                                appliedBy: 'admin@mft.com',
                                appliedAt: window.serverTimestamp(),
                                alertId: null, // Will be updated after alert creation
                                date: today,
                                category: 'manual', // vs 'automatic' for policy violations
                                description: `${penaltyType === 'deduction' ? 'Penalty' : 'Bonus'} of ${absValue} day(s) applied via alert: ${formData.title}`
                            };

                            await window.addDoc(window.collection(window.db, 'penalties'), penaltyRecord);
                        }
                    }
                }

                // Create alert document
                const alertData = {
                    ...formData,
                    recipients: recipients,
                    sentBy: 'admin@mft.com',
                    sentAt: window.serverTimestamp(),
                    recipientCount: recipients.length,
                    isRead: false,
                    createdAt: window.serverTimestamp(),
                    hasPenalty: !!formData.penalty,
                    penaltyApplied: formData.penalty ? parseFloat(formData.penalty) : 0
                };

                const alertDoc = await window.addDoc(window.collection(window.db, 'alerts'), alertData);

                // Update penalty records with alert ID if penalties were applied
                if (formData.penalty) {
                    const penaltyQuery = window.query(
                        window.collection(window.db, 'penalties'),
                        window.where('alertId', '==', null)
                    );
                    const penaltySnapshot = await window.getDocs(penaltyQuery);
                    
                    penaltySnapshot.docs.forEach(async (doc) => {
                        const data = doc.data();
                        if (recipients.includes(data.workerId) && data.reason === formData.penaltyReason) {
                            await window.updateDoc(window.doc(window.db, 'penalties', doc.id), {
                                alertId: alertDoc.id
                            });
                        }
                    });
                }

                const penaltyMessage = formData.penalty 
                    ? ` with ${parseFloat(formData.penalty) > 0 ? 'penalty' : 'bonus'} of ${Math.abs(parseFloat(formData.penalty))} day(s)` 
                    : '';
                
                showNotification(`Alert sent successfully to ${recipients.length} worker(s)${penaltyMessage}!`);
                closeModal('sendAlertModal');
                document.getElementById('sendAlertForm').reset();

            } catch (error) {
                console.error('Error sending alert:', error);
                showError('Failed to send alert. Please try again.');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>

    <!-- Send Alert Modal -->
    <div id="sendAlertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì¢ Send Alert to Workers</h2>
                <span class="close" onclick="closeModal('sendAlertModal')">&times;</span>
            </div>
            <form class="modal-form" id="sendAlertForm" onsubmit="event.preventDefault(); sendAlert();">
                <div class="form-group">
                    <label class="form-label">Alert Type *</label>
                    <select class="form-select" id="alertType" required>
                        <option value="">Select alert type</option>
                        <option value="attendance">Attendance Warning</option>
                        <option value="performance">Performance Notice</option>
                        <option value="schedule">Schedule Update</option>
                        <option value="policy">Policy Reminder</option>
                        <option value="general">General Announcement</option>
                        <option value="urgent">Urgent Notice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Alert Title *</label>
                    <input type="text" class="form-input" id="alertTitle" required placeholder="Enter alert title">
                </div>
                <div class="form-group">
                    <label class="form-label">Message *</label>
                    <textarea class="form-textarea" id="alertMessage" required placeholder="Enter your message..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Send To *</label>
                    <select class="form-select" id="alertRecipient" required onchange="toggleRecipientFields()">
                        <option value="">Select recipients</option>
                        <option value="all">All Workers</option>
                        <option value="department">By Department</option>
                        <option value="individual">Individual Worker</option>
                        <option value="absent">Absent Workers Today</option>
                        <option value="late">Late Workers Today</option>
                        <option value="overtime">Overtime Workers</option>
                    </select>
                </div>
                <div class="form-group" id="departmentSelectGroup" style="display: none;">
                    <label class="form-label">Department</label>
                    <select class="form-select" id="alertDepartment">
                        <option value="">Select department</option>
                        <option value="development">Development</option>
                        <option value="design">Design</option>
                        <option value="marketing">Marketing</option>
                        <option value="management">Management</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="form-group" id="workerSelectGroup" style="display: none;">
                    <label class="form-label">Worker</label>
                    <select class="form-select" id="alertWorker">
                        <option value="">Select worker</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority *</label>
                    <select class="form-select" id="alertPriority" required>
                        <option value="">Select priority</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Apply Penalty/Discount (Optional)</label>
                    <select class="form-select" id="alertPenalty">
                        <option value="">No penalty</option>
                        <option value="0.25">Deduct 0.25 day (Quarter day)</option>
                        <option value="0.5">Deduct 0.5 day (Half day)</option>
                        <option value="1">Deduct 1 full day</option>
                        <option value="1.5">Deduct 1.5 days</option>
                        <option value="2">Deduct 2 full days</option>
                        <option value="-0.25">Add 0.25 day bonus</option>
                        <option value="-0.5">Add 0.5 day bonus</option>
                        <option value="-1">Add 1 day bonus</option>
                    </select>
                    <div class="form-help" style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                        ‚ö†Ô∏è Penalties will be applied to workers' attendance records. Use carefully!
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Penalty Reason (Required if penalty selected)</label>
                    <input type="text" class="form-input" id="alertPenaltyReason" placeholder="e.g., Late arrival, Policy violation, Outstanding performance">
                    <div class="form-help" style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                        This reason will be recorded with the penalty for audit purposes
                    </div>
                </div>
                
                <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px; margin-top: 15px;">
                    <h4 style="color: #ffc107; margin: 0 0 8px 0; font-size: 0.9rem;">‚ÑπÔ∏è How Penalties Work:</h4>
                    <div style="color: #fff; font-size: 0.8rem; line-height: 1.4;">
                        ‚Ä¢ Penalties are automatically recorded in worker attendance records<br>
                        ‚Ä¢ All penalties are tracked in the "Penalties & Bonuses" HR report<br>
                        ‚Ä¢ Workers will receive the alert but penalties are applied separately<br>
                        ‚Ä¢ Positive values = deductions, negative values = bonuses
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('sendAlertModal')">Cancel</button>
                    <button type="submit" class="btn-submit">Send Alert</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Worker Dashboard JavaScript Functions -->
    <script>
        let currentWorkerDashboard = null;

        // Open worker dashboard
        async function openWorkerDashboard(workerId) {
            // Ensure HR data is loaded
            if (!hrData.workers || hrData.workers.length === 0) {
                try {
                    await loadHRWorkers();
                    await loadHRWorkSessions();
                } catch (error) {
                    console.error('Error loading HR data:', error);
                }
            }
            
            // Look in both allWorkers and hrData.workers arrays
            let worker = allWorkers.find(w => w.id === workerId);
            if (!worker) {
                worker = hrData.workers.find(w => w.id === workerId);
            }
            
            if (!worker) {
                console.error('Worker not found with ID:', workerId);
                console.log('Available workers in allWorkers:', allWorkers.map(w => ({ id: w.id, name: `${w.firstName} ${w.lastName}` })));
                console.log('Available workers in hrData.workers:', hrData.workers.map(w => ({ id: w.id, name: `${w.firstName} ${w.lastName}` })));
                alert('Worker not found! Please try refreshing the page.');
                return;
            }

            currentWorkerDashboard = worker;
            populateWorkerDashboard(worker);
            document.getElementById('workerDashboardModal').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Close worker dashboard
        function closeWorkerDashboard() {
            document.getElementById('workerDashboardModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentWorkerDashboard = null;
        }

        // Populate worker dashboard with data
        function populateWorkerDashboard(worker) {
            // Set basic info
            document.getElementById('workerAvatarInitials').textContent = 
                `${worker.firstName.charAt(0)}${worker.lastName.charAt(0)}`;
            document.getElementById('workerDashboardName').textContent = 
                `${worker.firstName} ${worker.lastName}`;
            document.getElementById('workerDashboardRole').textContent = 
                formatRole(worker.role);
            
            // Set status badges
            document.getElementById('workerDashboardStatus').textContent = 
                worker.status.toUpperCase();
            document.getElementById('workerDashboardStatus').className = 
                `status-badge status-${worker.status}`;
            
            document.getElementById('workerDashboardOnline').textContent = 
                worker.isOnline ? 'üü¢ Online' : 'üî¥ Offline';
            document.getElementById('workerDashboardOnline').className = 
                `status-badge ${worker.isOnline ? 'online' : 'offline'}`;

            // Calculate and populate stats
            populateWorkerStats(worker);
            
            // Populate overview tab
            populateOverviewTab(worker);
            
            // Populate attendance tab
            populateAttendanceTab(worker);
            
            // Populate tasks tab
            populateTasksTab(worker);
            
            // Populate performance tab
            populatePerformanceTab(worker);
            
            // Populate payroll tab
            populatePayrollTab(worker);
        }

        // Populate worker statistics
        function populateWorkerStats(worker) {
            try {
                // Ensure hrData.workSessions exists
                if (!hrData.workSessions) {
                    hrData.workSessions = [];
                }
                
                const workerSessions = hrData.workSessions.filter(s => {
                    try {
                        return s && s.workerId === worker.id;
                    } catch (error) {
                        console.error('Error filtering session:', error);
                        return false;
                    }
                });
                
                const totalHours = workerSessions.reduce((sum, s) => {
                    try {
                        const workTime = s.totalWorkTime || 0;
                        return sum + (workTime / (1000 * 60 * 60));
                    } catch (error) {
                        console.error('Error calculating work time:', error);
                        return sum;
                    }
                }, 0);
                
                const attendanceRate = calculateAttendanceRate(worker);
                const hourlyRate = worker.hourlyRate || 25;
                const earnings = totalHours * hourlyRate;

                document.getElementById('workerTotalHours').textContent = `${Math.round(totalHours * 10) / 10}h`;
                document.getElementById('workerAttendance').textContent = `${Math.round(attendanceRate)}%`;
                document.getElementById('workerTasksCompleted').textContent = worker.completedTasks || 0;
                document.getElementById('workerEarnings').textContent = `EGP ${Math.round(earnings)}`;
            } catch (error) {
                console.error('Error populating worker stats:', error);
                document.getElementById('workerTotalHours').textContent = '0h';
                document.getElementById('workerAttendance').textContent = '0%';
                document.getElementById('workerTasksCompleted').textContent = '0';
                document.getElementById('workerEarnings').textContent = 'EGP 0';
            }
        }

        // Populate overview tab
        function populateOverviewTab(worker) {
            // Personal Information
            document.getElementById('workerPersonalInfo').innerHTML = `
                <div class="info-item">
                    <span class="info-label">Full Name</span>
                    <span class="info-value">${worker.firstName} ${worker.lastName}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value">${worker.email}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value">${worker.phone}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Role</span>
                    <span class="info-value">${formatRole(worker.role)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Experience</span>
                    <span class="info-value">${worker.experience || 'N/A'}</span>
                </div>
            `;

            // Work Information
            document.getElementById('workerWorkInfo').innerHTML = `
                <div class="info-item">
                    <span class="info-label">Department</span>
                    <span class="info-value">${formatDepartment(worker.department)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Work Type</span>
                    <span class="info-value">${formatWorkType(worker.employmentType)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Expected Salary</span>
                    <span class="info-value">${worker.expectedSalary ? `EGP ${worker.expectedSalary}` : 'Not set'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Skills</span>
                    <span class="info-value">${worker.skills && worker.skills.length > 0 ? worker.skills.join(', ') : 'Not specified'}</span>
                </div>
            `;

            // Location & Contact Information
            document.getElementById('workerEmergencyInfo').innerHTML = `
                <div class="info-item">
                    <span class="info-label">Government</span>
                    <span class="info-value">${worker.government || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">City</span>
                    <span class="info-value">${worker.city || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Portfolio Link</span>
                    <span class="info-value">${worker.portfolioLink ? `<a href="${worker.portfolioLink}" target="_blank" style="color: #ef414b;">View Portfolio</a>` : 'Not provided'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Time to Leave Current Job</span>
                    <span class="info-value">${worker.netspend || 'Not specified'}</span>
                </div>
            `;

            // Activity Timeline
            populateActivityTimeline(worker);
        }

        // Populate activity timeline
        function populateActivityTimeline(worker) {
            // Ensure hrData.workSessions exists
            if (!hrData.workSessions) {
                hrData.workSessions = [];
            }
            
            const activities = [];
            
            if (worker.createdAt) {
                try {
                    const createdAt = worker.createdAt.toDate ? worker.createdAt.toDate() : new Date(worker.createdAt);
                    activities.push({
                        icon: 'üëã',
                        title: 'Account Created',
                        time: createdAt.toLocaleDateString()
                    });
                } catch (error) {
                    console.error('Error parsing createdAt:', error);
                }
            }
            
            if (worker.lastLogin) {
                try {
                    const lastLogin = worker.lastLogin.toDate ? worker.lastLogin.toDate() : new Date(worker.lastLogin);
                    activities.push({
                        icon: 'üü¢',
                        title: 'Last Login',
                        time: lastLogin.toLocaleString()
                    });
                } catch (error) {
                    console.error('Error parsing lastLogin:', error);
                }
            }
            
            if (worker.lastLogout) {
                try {
                    const lastLogout = worker.lastLogout.toDate ? worker.lastLogout.toDate() : new Date(worker.lastLogout);
                    activities.push({
                        icon: 'üî¥',
                        title: 'Last Logout',
                        time: lastLogout.toLocaleString()
                    });
                } catch (error) {
                    console.error('Error parsing lastLogout:', error);
                }
            }

            // Add recent work sessions
            const recentSessions = hrData.workSessions
                .filter(s => s.workerId === worker.id)
                .sort((a, b) => {
                    try {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA;
                    } catch (error) {
                        return 0;
                    }
                })
                .slice(0, 3);

            recentSessions.forEach(session => {
                try {
                    const workHours = Math.round((session.totalWorkTime || 0) / (1000 * 60 * 60) * 10) / 10;
                    activities.push({
                        icon: '‚è∞',
                        title: `Work Session - ${workHours}h`,
                        time: session.date || 'Unknown date'
                    });
                } catch (error) {
                    console.error('Error processing session:', error);
                }
            });

            document.getElementById('workerActivityTimeline').innerHTML = activities.length > 0 ? 
                activities.map(activity => `
                    <div class="timeline-item">
                        <div class="timeline-icon">${activity.icon}</div>
                        <div class="timeline-content">
                            <div class="timeline-title">${activity.title}</div>
                            <div class="timeline-time">${activity.time}</div>
                        </div>
                    </div>
                `).join('') : 
                '<div style="text-align: center; color: #888; padding: 20px;">No recent activity</div>';
        }

        // Populate attendance tab
        function populateAttendanceTab(worker) {
            try {
                // Ensure hrData.workSessions exists
                if (!hrData.workSessions) {
                    hrData.workSessions = [];
                }
                
                const workerSessions = hrData.workSessions.filter(s => {
                    try {
                        return s && s.workerId === worker.id;
                    } catch (error) {
                        console.error('Error filtering session:', error);
                        return false;
                    }
                });
                
                const totalSessions = workerSessions.length;
                const totalHours = workerSessions.reduce((sum, s) => {
                    try {
                        const workTime = s.totalWorkTime || 0;
                        return sum + (workTime / (1000 * 60 * 60));
                    } catch (error) {
                        console.error('Error calculating total hours:', error);
                        return sum;
                    }
                }, 0);
                
                const overtimeHours = workerSessions.reduce((sum, s) => {
                    try {
                        const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                        return sum + Math.max(0, sessionHours - 8);
                    } catch (error) {
                        console.error('Error calculating overtime:', error);
                        return sum;
                    }
                }, 0);

                document.getElementById('attendancePresent').textContent = totalSessions;
                document.getElementById('attendanceAbsent').textContent = '0'; // Would need more data
                document.getElementById('attendanceLate').textContent = '0'; // Would need more data
                document.getElementById('attendanceOvertime').textContent = `${Math.round(overtimeHours * 10) / 10}h`;

                // Create simple attendance calendar
                const calendar = document.getElementById('attendanceCalendar');
                calendar.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #888;">
                        <h4>üìÖ Work Sessions This Month</h4>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px;">
                            ${generateAttendanceCalendar(workerSessions)}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error populating attendance tab:', error);
                document.getElementById('attendancePresent').textContent = '0';
                document.getElementById('attendanceAbsent').textContent = '0';
                document.getElementById('attendanceLate').textContent = '0';
                document.getElementById('attendanceOvertime').textContent = '0h';
                document.getElementById('attendanceCalendar').innerHTML = 
                    '<div style="text-align: center; color: #ff4757; padding: 20px;">Error loading attendance data</div>';
            }
        }

        // Generate attendance calendar
        function generateAttendanceCalendar(sessions) {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            
            let calendarHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div style="height: 30px;"></div>';
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasSession = sessions.some(s => s.date === dateStr);
                const isToday = day === today.getDate();
                
                calendarHTML += `
                    <div style="
                        height: 30px; 
                        background: ${hasSession ? 'rgba(40, 167, 69, 0.3)' : 'rgba(255, 255, 255, 0.05)'}; 
                        border: ${isToday ? '2px solid #ef414b' : '1px solid rgba(255, 255, 255, 0.1)'};
                        border-radius: 4px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-size: 0.8rem;
                        color: ${hasSession ? '#28a745' : '#888'};
                        font-weight: ${isToday ? 'bold' : 'normal'};
                    ">
                        ${day}
                    </div>
                `;
            }
            
            return calendarHTML;
        }

        // Populate tasks tab
        function populateTasksTab(worker) {
            try {
                const totalTasks = worker.totalTasks || 0;
                const completedTasks = worker.completedTasks || 0;
                const pendingTasks = totalTasks - completedTasks;
                const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                document.getElementById('taskTotal').textContent = totalTasks;
                document.getElementById('taskCompleted').textContent = completedTasks;
                document.getElementById('taskPending').textContent = pendingTasks;
                document.getElementById('taskProgress').textContent = `${progress}%`;

                // Get worker's tasks from allTasks (ensure it exists)
                if (!allTasks) {
                    allTasks = [];
                }
                
                // Filter tasks safely
                const workerTasks = allTasks.filter(t => {
                    try {
                        return t && t.assignedTo === worker.id;
                    } catch (error) {
                        console.error('Error filtering task:', error);
                        return false;
                    }
                }).slice(0, 5);
                
                document.getElementById('recentTasksList').innerHTML = workerTasks.length > 0 ? 
                    workerTasks.map(task => {
                        try {
                            const taskTitle = task.title || 'Untitled Task';
                            const taskStatus = task.status || 'unknown';
                            const taskDescription = task.description || 'No description';
                            
                            return `
                                <div style="
                                    background: rgba(255, 255, 255, 0.03); 
                                    border: 1px solid rgba(255, 255, 255, 0.1); 
                                    border-radius: 8px; 
                                    padding: 15px; 
                                    margin-bottom: 10px;
                                ">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <strong style="color: #ffffff;">${taskTitle}</strong>
                                        <span class="status-badge status-${taskStatus}">${taskStatus.toUpperCase()}</span>
                                    </div>
                                    <div style="color: #cccccc; font-size: 0.9rem;">
                                        ${taskDescription}
                                    </div>
                                </div>
                            `;
                        } catch (error) {
                            console.error('Error rendering task:', error);
                            return '';
                        }
                    }).join('') : 
                    '<div style="text-align: center; color: #888; padding: 20px;">No tasks assigned yet</div>';
            } catch (error) {
                console.error('Error populating tasks tab:', error);
                document.getElementById('recentTasksList').innerHTML = 
                    '<div style="text-align: center; color: #ff4757; padding: 20px;">Error loading tasks</div>';
            }
        }

        // Populate performance tab
        function populatePerformanceTab(worker) {
            try {
                // Ensure hrData.workSessions exists
                if (!hrData.workSessions) {
                    hrData.workSessions = [];
                }
                
                const workerSessions = hrData.workSessions.filter(s => {
                    try {
                        return s && s.workerId === worker.id;
                    } catch (error) {
                        console.error('Error filtering session:', error);
                        return false;
                    }
                });
                
                const totalHours = workerSessions.reduce((sum, s) => {
                    try {
                        const workTime = s.totalWorkTime || 0;
                        return sum + (workTime / (1000 * 60 * 60));
                    } catch (error) {
                        console.error('Error calculating total hours:', error);
                        return sum;
                    }
                }, 0);
                
                const avgSessionLength = workerSessions.length > 0 ? totalHours / workerSessions.length : 0;
                const productivity = calculateProductivityScore(worker, workerSessions);
                const taskCompletionRate = worker.totalTasks > 0 ? Math.round((worker.completedTasks / worker.totalTasks) * 100) : 0;

                document.getElementById('productivityScore').textContent = `${productivity}%`;
                document.getElementById('productivityBar').style.width = `${productivity}%`;
                
                document.getElementById('taskCompletionRate').textContent = `${taskCompletionRate}%`;
                document.getElementById('taskCompletionBar').style.width = `${taskCompletionRate}%`;
                
                document.getElementById('avgSessionLength').textContent = `${Math.round(avgSessionLength * 10) / 10}h`;
                document.getElementById('sessionLengthBar').style.width = `${Math.min(avgSessionLength / 8 * 100, 100)}%`;
            } catch (error) {
                console.error('Error populating performance tab:', error);
                document.getElementById('productivityScore').textContent = '0%';
                document.getElementById('productivityBar').style.width = '0%';
                document.getElementById('taskCompletionRate').textContent = '0%';
                document.getElementById('taskCompletionBar').style.width = '0%';
                document.getElementById('avgSessionLength').textContent = '0h';
                document.getElementById('sessionLengthBar').style.width = '0%';
            }
        }

        // Populate payroll tab
        function populatePayrollTab(worker) {
            try {
                // Ensure hrData.workSessions exists
                if (!hrData.workSessions) {
                    hrData.workSessions = [];
                }
                
                const workerSessions = hrData.workSessions.filter(s => {
                    try {
                        return s && s.workerId === worker.id;
                    } catch (error) {
                        console.error('Error filtering session:', error);
                        return false;
                    }
                });
                
                const regularHours = workerSessions.reduce((sum, s) => {
                    try {
                        const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                        return sum + Math.min(sessionHours, 8);
                    } catch (error) {
                        console.error('Error calculating regular hours:', error);
                        return sum;
                    }
                }, 0);
                
                const overtimeHours = workerSessions.reduce((sum, s) => {
                    try {
                        const sessionHours = (s.totalWorkTime || 0) / (1000 * 60 * 60);
                        return sum + Math.max(0, sessionHours - 8);
                    } catch (error) {
                        console.error('Error calculating overtime hours:', error);
                        return sum;
                    }
                }, 0);
                
                const hourlyRate = worker.hourlyRate || 25;
                const totalEarnings = (regularHours * hourlyRate) + (overtimeHours * hourlyRate * 1.5);

                document.getElementById('regularHours').textContent = `${Math.round(regularHours * 10) / 10}h`;
                document.getElementById('overtimeHours').textContent = `${Math.round(overtimeHours * 10) / 10}h`;
                document.getElementById('hourlyRate').textContent = `EGP ${hourlyRate}`;
                document.getElementById('totalEarnings').textContent = `EGP ${Math.round(totalEarnings)}`;
            } catch (error) {
                console.error('Error populating payroll tab:', error);
                document.getElementById('regularHours').textContent = '0h';
                document.getElementById('overtimeHours').textContent = '0h';
                document.getElementById('hourlyRate').textContent = 'EGP 0';
                document.getElementById('totalEarnings').textContent = 'EGP 0';
            }
        }

        // Switch worker dashboard tabs
        function switchWorkerTab(tabName) {
            // Remove active class from all tabs and panels
            document.querySelectorAll('.dashboard-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.dashboard-tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Add active class to selected tab and panel
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Calculate attendance rate
        function calculateAttendanceRate(worker) {
            try {
                // Ensure hrData.workSessions exists
                if (!hrData.workSessions) {
                    hrData.workSessions = [];
                }
                
                const workerSessions = hrData.workSessions.filter(s => {
                    try {
                        return s && s.workerId === worker.id;
                    } catch (error) {
                        console.error('Error filtering session for attendance:', error);
                        return false;
                    }
                });
                
                const expectedWorkDays = 22; // Standard working days per month
                const actualWorkDays = workerSessions.length;
                return Math.round((actualWorkDays / expectedWorkDays) * 100);
            } catch (error) {
                console.error('Error calculating attendance rate:', error);
                return 0;
            }
        }

        // Calculate productivity score
        function calculateProductivityScore(worker, sessions) {
            try {
                if (sessions.length === 0) return 0;
                
                const totalHours = sessions.reduce((sum, s) => {
                    try {
                        const workTime = s.totalWorkTime || 0;
                        return sum + (workTime / (1000 * 60 * 60));
                    } catch (error) {
                        console.error('Error calculating work time for productivity:', error);
                        return sum;
                    }
                }, 0);
                
                const avgSessionLength = totalHours / sessions.length;
                const taskCompletionRate = worker.totalTasks > 0 ? (worker.completedTasks / worker.totalTasks) * 100 : 0;
                
                // Simple productivity calculation
                const hoursScore = Math.min(avgSessionLength / 8 * 100, 100);
                const taskScore = taskCompletionRate;
                
                return Math.round((hoursScore + taskScore) / 2);
            } catch (error) {
                console.error('Error calculating productivity score:', error);
                return 0;
            }
        }

        // Close modal when clicking outside
        document.getElementById('workerDashboardModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWorkerDashboard();
            }
        });

        // Async wrapper for opening worker dashboard
        function openWorkerDashboardAsync(workerId) {
            openWorkerDashboard(workerId).catch(error => {
                console.error('Error opening worker dashboard:', error);
                alert('Error opening worker dashboard. Please try again.');
            });
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('workerDashboardModal').style.display === 'block') {
                closeWorkerDashboard();
            }
        });
    </script>
</body>
</html> 
